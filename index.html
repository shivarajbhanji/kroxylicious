<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.21">
<meta name="author" content="3.0, July 29, 2022: AsciiDoc article template">
<title>Kroxylicious Proxy</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #f8f8f8; }
pre.pygments .tok-c { color: #3D7B7B; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #9C6500 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #E40000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #008400 } /* Generic.Inserted */
pre.pygments .tok-go { color: #717171 } /* Generic.Output */
pre.pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #B00040 } /* Keyword.Type */
pre.pygments .tok-m { color: #666666 } /* Literal.Number */
pre.pygments .tok-s { color: #BA2121 } /* Literal.String */
pre.pygments .tok-na { color: #687822 } /* Name.Attribute */
pre.pygments .tok-nb { color: #008000 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #880000 } /* Name.Constant */
pre.pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #717171; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #0000FF } /* Name.Function */
pre.pygments .tok-nl { color: #767600 } /* Name.Label */
pre.pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #19177C } /* Name.Variable */
pre.pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
pre.pygments .tok-se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #008000 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #A45A77 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article">
<div id="header">
<h1>Kroxylicious Proxy</h1>
<div class="details">
<span id="author" class="author">3.0, July 29, 2022: AsciiDoc article template</span><br>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_overview">Overview</a>
<ul class="sectlevel2">
<li><a href="#_what_is_kroxylicious_proxy">What is Kroxylicious Proxy?</a></li>
<li><a href="#_why">Why?</a></li>
<li><a href="#_how_it_works">How it works</a></li>
<li><a href="#_implementation">Implementation</a></li>
<li><a href="#_deployment_topologies">Deployment topologies</a></li>
<li><a href="#_more_about_filters">More about filters</a></li>
</ul>
</li>
<li><a href="#_filters">Filters</a>
<ul class="sectlevel2">
<li><a href="#_built_in_filters">Built-in filters</a></li>
<li><a href="#_envelope_encryption">Envelope Encryption</a></li>
<li><a href="#_multi_tenancy">Multi-tenancy</a></li>
<li><a href="#_schema_validation">Schema-validation</a></li>
<li><a href="#_community_filters">Community filters</a></li>
</ul>
</li>
<li><a href="#_custom_filters">Custom Filters</a>
<ul class="sectlevel2">
<li><a href="#_sample_custom_filter_project">Sample Custom Filter Project</a></li>
<li><a href="#_api_docs">API docs</a></li>
<li><a href="#_dependencies">Dependencies</a></li>
<li><a href="#_protocol_filters">Protocol filters</a></li>
<li><a href="#_packaging_filters">Packaging filters</a></li>
</ul>
</li>
<li><a href="#_deploying_proxies">Deploying proxies</a>
<ul class="sectlevel2">
<li><a href="#_selecting_plugins">Selecting plugins</a></li>
<li><a href="#_providing_implementations_for_facades">Providing implementations for facades</a></li>
<li><a href="#_configuring_virtual_clusters">Configuring virtual clusters</a></li>
<li><a href="#_configuring_proxy_plugins">Configuring proxy plugins</a></li>
</ul>
</li>
<li><a href="#_operating_proxies">Operating proxies</a>
<ul class="sectlevel2">
<li><a href="#_logging">Logging</a></li>
<li><a href="#_configuring_tls">Configuring TLS</a></li>
<li><a href="#_reconfiguration">Reconfiguration</a></li>
<li><a href="#_monitoring_and_observability">Monitoring and observability</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a><a class="link" href="#_overview">Overview</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_what_is_kroxylicious_proxy"><a class="anchor" href="#_what_is_kroxylicious_proxy"></a><a class="link" href="#_what_is_kroxylicious_proxy">What is Kroxylicious Proxy?</a></h3>
<div class="paragraph">
<p>Kroxylicious Proxy provides a pluggable, protocol-aware ("Layer 7") proxy for <a href="https://kafka.apache.org">Apache Kafka&#174;</a> brokers and clusters, together with an API for conveniently implementing custom logic within such a proxy.</p>
</div>
</div>
<div class="sect2">
<h3 id="_why"><a class="anchor" href="#_why"></a><a class="link" href="#_why">Why?</a></h3>
<div class="paragraph">
<p>Proxies are a powerful and flexible architectural pattern.
For Kafka, they can be used to add functionality to Kafka clusters which is not available out-of-the-box with Apache Kafka.
In an ideal world, such functionality would be implemented directly in Apache Kafka.
But there are numerous practical reasons that can prevent this, for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Organizations having very niche requirements which are unsuitable for implementation directly in Apache Kafka.</p>
</li>
<li>
<p>Functionality which requires changes to Kafka&#8217;s public API and which the Apache Kafka project is unwilling to implement.
This is the case for <a href="https://lists.apache.org/thread/x1p119hkpoy01vq9ck3d0ql67jtvm875">broker interceptors</a>, for example.</p>
</li>
<li>
<p>Experimental functionality which might end up being implemented in Apache Kafka eventually.
For example using Kroxylicious proxy it&#8217;s easier to experiment with alternative transport protocols, such as Quic, or operating system APIs, such as io_uring, because there is already support for this in Netty, the networking framework on which Kroxylicious is built.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_how_it_works"><a class="anchor" href="#_how_it_works"></a><a class="link" href="#_how_it_works">How it works</a></h3>
<div class="paragraph">
<p>First let&#8217;s define the concepts in the landscape surrounding Kroxylicious.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>Kafka Client</em>, or <em>Client</em> refers to any client application using a Kafka Client library to talk to a <strong>Kafka Cluster</strong>.</p>
</li>
<li>
<p><em>Kafka Cluster</em> or <em>Cluster</em> refers to a cluster comprising one or more Kafka Brokers.</p>
</li>
<li>
<p><em>Downstream</em> refers to the area between Kafka Client and Kroxylicious.</p>
</li>
<li>
<p><em>Upstream</em> refers to the area between Kroxylicious and a Kafka Cluster.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-a2s-md5-00ea80ca071ece7ef3f5648aa70e594c.svg" alt="Diagram" width="702" height="448">
</div>
<div class="title">Figure 1. Kroxylious landscape</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s define some concepts used within Kroxylicious itself.</p>
</div>
<div class="sect3">
<h4 id="_virtual_cluster"><a class="anchor" href="#_virtual_cluster"></a><a class="link" href="#_virtual_cluster">Virtual Cluster</a></h4>
<div class="paragraph">
<p>The <em>Virtual Cluster</em> is the downstream representation of a Kafka Cluster.  At the conceptual level, a Kafka Client
connects to a Virtual Cluster.  Kroxylicious proxies all communications made to the Virtual Cluster through to a
(physical) Kafka Cluster, passing it through the <em>Filter Chain</em>.</p>
</div>
<div class="paragraph">
<p>So far, this explanation has elided the detail of Kafka Brokers.  Let&#8217;s talk about that now.</p>
</div>
<div class="paragraph">
<p>The Virtual Cluster automatically exposes a bootstrap endpoint for the Virtual Cluster.  This is what the Kafka Client
must specify as the <a href="https://kafka.apache.org/documentation/#producerconfigs_bootstrap.servers">bootstrap.servers</a> property
in the client configuration.</p>
</div>
<div class="paragraph">
<p>In addition to the bootstrap endpoint, Kroxylicious automatically exposes broker endpoints.  There is one broker endpoint
for each broker of the physical cluster.  When the Client connects to a broker endpoint, Kroxylicious proxies all
communications to the corresponding broker of the (physical) Kafka Cluster.</p>
</div>
<div class="paragraph">
<p>Kroxylicious automatically intercepts all the Kafka RPC responses that contain a broker address.  It rewrites the address
so that it refers to the corresponding broker endpoint of the Virtual Cluster.  This means when the Kafka Client
goes to connect to, say broker 0, it does so through the Virtual Cluster.</p>
</div>
</div>
<div class="sect3">
<h4 id="_target_cluster"><a class="anchor" href="#_target_cluster"></a><a class="link" href="#_target_cluster">Target Cluster</a></h4>
<div class="paragraph">
<p>The <em>Target Cluster</em> is the definition of physical Kafka Cluster within the Kroxylicious itself.</p>
</div>
<div class="paragraph">
<p>A <em>Virtual Cluster</em> has exactly one <em>Target Cluster</em>.</p>
</div>
<div class="paragraph">
<p>There can be a <em>one-to-one</em> relationship between Virtual Clusters and Target Clusters.
The other possibility is <em>many-to-one</em>, where many Virtual Clusters point to the same Target Cluster.  The
many-to-one pattern is exploited by filters such as the <a href="#_multi_tenancy">Multi-tenancy</a>
filter.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-a2s-md5-24c6f94dc024b0582186e5a234626d03.svg" alt="Diagram" width="792" height="288">
</div>
<div class="title">Figure 2. One-to-One relationship between Virtual Cluster and Target Cluster</div>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-a2s-md5-c2b81d2dc4bc8ca99208673c81c8c071.svg" alt="Diagram" width="792" height="416">
</div>
<div class="title">Figure 3. Many-to-one between Virtual Cluster and Target Cluster</div>
</div>
<div class="paragraph">
<p>A one-to-many pattern, where one Virtual Cluster points to many Target Clusters (providing amalgamation),
is not a supported use-case.</p>
</div>
</div>
<div class="sect3">
<h4 id="_filter_chain"><a class="anchor" href="#_filter_chain"></a><a class="link" href="#_filter_chain">Filter Chain</a></h4>
<div class="paragraph">
<p>A <em>Filter Chain</em> consists of an <strong>ordered list</strong> of pluggable <em>protocol filters</em>.</p>
</div>
<div class="paragraph">
<p>A  <em>protocol filter</em> implements some logic for intercepting, inspecting and/or manipulating Kafka protocol messages.
Kafka protocol requests (such as <code>Produce</code> requests) pass sequentially through each of the protocol filters in the
chain, beginning with the 1st filter in the chain and then following with the subsequent filters, before being
forwarded to the broker.</p>
</div>
<div class="paragraph">
<p>When the broker returns a response (such as a <code>Produce</code> response) the protocol filters in the chain are invoked in the
reverse order (that is, beginning with the nth filter in the chain, then the n-1th and so on) with each having the
opportunity to inspect and/or manipulating the response. Eventually a response is returned to the client.</p>
</div>
<div class="paragraph">
<p>The description above describes only the basic capabilities of the protocol filter. Richer features of filters
are described later.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-a2s-md5-0a81c031d02fc4fdea01a37bc2114bcc.svg" alt="Diagram" width="1089" height="368">
</div>
<div class="title">Figure 4. Illustration of a request and response being manipulated by filters in a chain</div>
</div>
<div class="paragraph">
<p>As mentioned above, Kroxylicious takes the responsibility to rewrite the Kafka RPC responses that carry broker address
information so that they reflect the broker addresses exposed by the Virtual Cluster. These are the
<a href="https://kafka.apache.org/protocol.html#The_Messages_Metadata"><code>Metadata</code></a>,
<a href="https://kafka.apache.org/protocol.html#The_Messages_DescribeCluster"><code>DescribeCluster</code></a> and
<a href="https://kafka.apache.org/protocol.html#The_Messages_FindCoordinator"><code>FindCoordinator</code></a> responses. This processing is
entirely transparent to the work of the protocol filters.  <em>Filter authors</em> are free to write their own filters that
intercept these responses too.</p>
</div>
</div>
<div class="sect3">
<h4 id="_filter_composition"><a class="anchor" href="#_filter_composition"></a><a class="link" href="#_filter_composition">Filter composition</a></h4>
<div class="paragraph">
<p>An important principal for the protocol filter API is that filters should <em>compose</em> nicely.
That means that filters generally don&#8217;t know what other filters might be present in the chain, and what they might be doing to messages.
When a filter forwards a request or response it doesn&#8217;t know whether the message is being sent to the next filter in the chain, or straight back to the client.</p>
</div>
<div class="paragraph">
<p>Such composition is important because it means a <em>proxy user</em> can configure multiple filters (possibly written by several <em>filter authors</em>) and expect to get the combined effect of all of them.</p>
</div>
<div class="paragraph">
<p>It&#8217;s never quite that simple, of course.
In practice they will often need to understand what each filter does in some detail in order to be able to operate their proxy properly, for example by understanding whatever metrics each filter is emitting.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_implementation"><a class="anchor" href="#_implementation"></a><a class="link" href="#_implementation">Implementation</a></h3>
<div class="paragraph">
<p>The proxy is written in Java, on top of <a href="https://netty.io">Netty</a>.
The usual <a href="https://netty.io/4.1/api/io/netty/channel/ChannelHandler.html"><code>ChannelHandlers</code></a> provided by the Netty project are used where appropriate (e.g. SSL support uses <a href="https://netty.io/4.1/api/io/netty/handler/ssl/SslHandler.html"><code>SslHandler</code></a>), and Kroxylicious provides Kafka-specific handlers of its own.</p>
</div>
<div class="paragraph">
<p>The Kafka-aware parts use the Apache Kafka project&#8217;s own classes for serialization and deserialization.</p>
</div>
<div class="paragraph">
<p>Protocol filters get executed using a handler-per-filter model.</p>
</div>
</div>
<div class="sect2">
<h3 id="_deployment_topologies"><a class="anchor" href="#_deployment_topologies"></a><a class="link" href="#_deployment_topologies">Deployment topologies</a></h3>
<div class="paragraph">
<p>The proxy supports a range of possible deployment topologies.
Which style is used depends on what the proxy is meant to <em>achieve</em>, architecturally speaking.
Broadly speaking a proxy instance can be deployed:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">As a forward proxy</dt>
<dd>
<p>Proxying the access of one or more clients to a particular cluster/broker that might also accessible (to other clients) directly.</p>
<div class="paragraph">
<p>Topic-level encryption provides one example use case for a forward proxy-style deployment.
This might be applicable when using clients that don&#8217;t support interceptors, or if an organisation wants to apply the same encryption policy in a single place, securing access to the keys within their network.</p>
</div>
</dd>
<dt class="hdlist1">As a reverse proxy</dt>
<dd>
<p>Proxying access for all clients trying to reach a particular cluster/broker.</p>
<div class="paragraph">
<p>Transparent multi-tenancy provides an example use case for a reverse proxy.
While Apache Kafka itself has some features that enable multi-tenancy, they rely on topic name prefixing as the primary mechanism for ensuring namespace isolation.
Tenants have to adhere to the naming policy and know they&#8217;re a tenant of a larger shared cluster.</p>
</div>
<div class="paragraph">
<p><em>Transparent</em> multi-tenancy means each tenant has the illusion of having their own cluster, with almost complete freedom over topic and group naming, while still actually sharing a cluster.</p>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>We can further classify deployment topologies in how many proxy instances are used. For example:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Single proxy instance</dt>
<dt class="hdlist1">Proxy pool</dt>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_more_about_filters"><a class="anchor" href="#_more_about_filters"></a><a class="link" href="#_more_about_filters">More about filters</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_filters"><a class="anchor" href="#_filters"></a><a class="link" href="#_filters">Filters</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_built_in_filters"><a class="anchor" href="#_built_in_filters"></a><a class="link" href="#_built_in_filters">Built-in filters</a></h3>
<div class="paragraph">
<p>The following filters are provided built-in as part of the distribution.</p>
</div>
</div>
<div class="sect2">
<h3 id="_envelope_encryption"><a class="anchor" href="#_envelope_encryption"></a><a class="link" href="#_envelope_encryption">Envelope Encryption</a></h3>
<div class="sect3">
<h4 id="_what_is_it"><a class="anchor" href="#_what_is_it"></a><a class="link" href="#_what_is_it">What is it?</a></h4>
<div class="paragraph">
<p>A filter that transparently provides an <a href="https://kroxylicious.io/use-cases/">encryption-at-rest solution</a> for Apache Kafka.</p>
</div>
<div class="paragraph">
<p>At a high level, the filter works in the following way.  First, let&#8217;s consider the produce side:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The filter intercepts produce requests sent from producing Kafka Clients.</p>
</li>
<li>
<p>The filter disassembles the produce request.</p>
</li>
<li>
<p>Each record within it is encrypted.</p>
</li>
<li>
<p>The produce request is reassembled, replacing the original records with their encrypted counterparts.</p>
</li>
<li>
<p>The filter forwards the modified produce request onto the Kafka Broker.</p>
</li>
<li>
<p>The broker handles the records in the normal way (writing them to the topic&#8217;s log etc).  The broker has no knowledge
that the records are encrypted - to it, they are just opaque bytes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now, let&#8217;s consider the consume side:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The filter intercepts the fetch responses sent by the Kafka Broker to the consuming Kafka Client.</p>
</li>
<li>
<p>The filter disassembles the fetch response.</p>
</li>
<li>
<p>Each record is decrypted.</p>
</li>
<li>
<p>The fetch response is reassembled, replacing the encrypted records with their unencrypted counterparts.</p>
</li>
<li>
<p>The filter forwards the modified fetch response onto the Kafka Client. The client has no knowledge that the record was encrypted.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The entire process is transparent from the point of view of both Kafka Client and Kafka Broker.  Neither are
aware that the records are being encrypted.  Neither client nor broker have any access to the encryption keys or have
any influence on the ciphering process.</p>
</div>
<div class="paragraph">
<p>The filter encrypts the records using symmetric encryption keys.  The encryption technique employed is
known as <strong>Envelope Encryption</strong>, which is a technique suited for encrypting large volumes of data in an efficient manner.
Envelope Encryption is described in the next section.</p>
</div>
<div class="paragraph">
<p>The filter integrates with a Key Management Service (KMS).  It is the Key Management Service (KMS) that has
ultimate responsibility for the safe storage of key material.  The role of the KMS is discussed later.</p>
</div>
<div class="sect4">
<h5 id="_envelope_encryption_2"><a class="anchor" href="#_envelope_encryption_2"></a><a class="link" href="#_envelope_encryption_2">Envelope Encryption</a></h5>
<div class="paragraph">
<p>Envelope Encryption is a technique described by <a href="https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-57pt1r5.pdf">NIST
Special Publication 800-57 Part 1 Revision 5</a>. It is the practice of encrypting the data with a Data Encryption Key (DEK),
then wrapping (encrypting) the DEK with a Key Encryption Key (KEK).  In this section we discuss how Envelope Encryption is
employed by the filter to encrypt Kafka records.  For more detail, refer to the <a href="https://github.com/kroxylicious/kroxylicious/blob/main/kroxylicious-filters/kroxylicious-encryption/doc/design.adoc">design</a>.</p>
</div>
<div class="paragraph">
<p>On the produce path, the filter is encrypting records.  The filter uses a selector to determine which KEK to apply. It then
requests that the KMS generates a DEK for the KEK.  It is the DEK that is used to encrypt the record.  The original record
in the produce request is replaced by a <strong>cipher record</strong> which comprises the encrypted record, the encrypted DEK and some other
metadata.</p>
</div>
<div class="paragraph">
<p>On the fetch path, the filter is decrypting records.  The filter receives the <strong>cipher record</strong> from the Kafka Broker. The
filter reverses the process used to construct the <strong>cipher record</strong> and uses the KMS to decrypt the DEK.  The decrypted DEK is
used to decrypt the encrypted record.  The cipher record in the fetch response is then replaced with the decrypted record.</p>
</div>
<div class="paragraph">
<p>On the produce path, the filter employs a DEK reuse strategy. This means that records sent by a single connection to
the same topic will be encrypted using the same DEK (until a time-out or encryption operations limit is reached, whichever
occurs first).  This prevents key exhaustion and prevents excessive interactions with the KMS.</p>
</div>
<div class="paragraph">
<p>On the fetch path, the filter employs an LRU strategy to keep recently encountered DEKs decrypted in memory. This
prevents excessive interactions with the KMS.</p>
</div>
</div>
<div class="sect4">
<h5 id="_role_of_the_kms"><a class="anchor" href="#_role_of_the_kms"></a><a class="link" href="#_role_of_the_kms">Role of the KMS</a></h5>
<div class="paragraph">
<p>The Key Management Service (KMS) is the <strong>secure repository</strong> for Key Encryption Keys (KEKs). The key material of the KEK
<strong>never</strong> leaves the confines of the KMS.  The KMS exposes cryptographic functions that operate against the KEKs stored
within it.</p>
</div>
<div class="paragraph">
<p>The KMS is also the <strong>source</strong> of Data Encryption Keys (DEKs).  When the KMS generates a DEK for a given KEK, it returns
the DEK (which is securely generated random data), together with the encrypted DEK (which is the same data, encrypted
using the KEK).  Note that the KMS does not <strong>store</strong> the DEKs - DEKs are stored encrypted as part of the Kafka record held
by the broker.</p>
</div>
<div class="paragraph">
<p>The filter uses the services of the KMS to generate DEKs, and decrypt encrypted DEKs.</p>
</div>
<div class="paragraph">
<p>The KMS must be available at runtime. If the KMS is unavailable, it will become impossible to produce or consume
records through the filter until the KMS service is restored.</p>
</div>
<div class="paragraph">
<p>The filter currently has a single KMS integration with <a href="https://www.hashicorp.com/">HashiCorp Vault&#174;</a>.  More KMS
integrations are planned. It is also possible for a user to implement their own KMS integration.  The implementation
must implement the <a href="https://javadoc.io/doc/io.kroxylicious/kroxylicious-kms/latest/io/kroxylicious/kms/service/KmsService.html">KMS public API</a> and make the
implementation available on the classpath with the service loader mechanism.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It is recommended to use a KMS in a highly available configuration.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_key_rotation"><a class="anchor" href="#_key_rotation"></a><a class="link" href="#_key_rotation">Key rotation</a></h5>
<div class="paragraph">
<p>Key rotation is the practice of periodically replacing cryptographic keys with new ones.  Using key rotation is
considered cryptographic best-practice.</p>
</div>
<div class="paragraph">
<p>The filter allows for the rotation of KEKs within the KMS. When a KEK is rotated, the new key material will be applied
to newly produced records. Existing records (which were encrypted with older versions of the KEK) remain decryptable
as long as the previous KEK version remains present in the KMS.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If the previous KEK version is removed from the KMS, the records encrypted with that key version will become
un-consumable (that is, the fetch will fail). In this case, the consumer offset must be advanced beyond those records.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_what_exactly_gets_encrypted"><a class="anchor" href="#_what_exactly_gets_encrypted"></a><a class="link" href="#_what_exactly_gets_encrypted">What exactly gets encrypted?</a></h5>
<div class="paragraph">
<p>The filter currently encrypts only <strong>record values</strong>.  Record keys, headers, timestamps are not encrypted.</p>
</div>
<div class="paragraph">
<p>Null record values (which represent deletes, or <em>tombstones</em>, in compacted topics) sent by producers are passed through
to the broker unencrypted. This means encryption may be applied to compacted topics too. Deletes will function normally.</p>
</div>
<div class="paragraph">
<p>The presence of unencrypted records on a topic configured for encryption is allowed.  The unencrypted records will get
passed through to consumer as normal. This supports the use-case where encryption is introduced to an against system where
topics are already populated with unencrypted content.</p>
</div>
<div class="paragraph">
<p>The filter supports use-cases where some Kafka topics are configured for encryption while others are left to be
unencrypted.</p>
</div>
<div class="paragraph">
<p>Transactions producing to both encrypted and unencrypted topics are supported.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_how_to_use_the_filter"><a class="anchor" href="#_how_to_use_the_filter"></a><a class="link" href="#_how_to_use_the_filter">How to use the filter</a></h4>
<div class="paragraph">
<p>There are three steps to using the filter.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Setting up the KMS.</p>
</li>
<li>
<p>Configuring the filter within Kroxylicious.</p>
</li>
<li>
<p>Establishing the encryption key(s) within the KMS that will be used to encrypt the topics.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>These steps are described in the next sections.</p>
</div>
<div class="sect4">
<h5 id="_setting_up_the_kms"><a class="anchor" href="#_setting_up_the_kms"></a><a class="link" href="#_setting_up_the_kms">Setting up the KMS</a></h5>
<div class="paragraph">
<p>In order to set up the KMS provider ready to use with the filter, follow these KMS provider specific steps.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_hashicorp_vault"><a class="anchor" href="#_hashicorp_vault"></a><a class="link" href="#_hashicorp_vault">HashiCorp Vault</a></h4>
<div class="sect4">
<h5 id="_enable_the_transit_engine"><a class="anchor" href="#_enable_the_transit_engine"></a><a class="link" href="#_enable_the_transit_engine">Enable the Transit Engine</a></h5>
<div class="paragraph">
<p>The filter integrates with the <a href="https://developer.hashicorp.com/vault/docs/secrets/transit">HashiCorp Vault <strong>Transit
Engine</strong></a>.   Vault does not enable the Transit Engine by default.  It must be
<a href="https://developer.hashicorp.com/vault/docs/secrets/transit#setup">enabled</a> before it can be used with the filter.</p>
</div>
</div>
<div class="sect4">
<h5 id="_vault_transit_engine_url"><a class="anchor" href="#_vault_transit_engine_url"></a><a class="link" href="#_vault_transit_engine_url">Vault Transit Engine URL</a></h5>
<div class="paragraph">
<p>The Vault Transit Engine URL is required so the filter knows the location of the Transit Engine within the
Vault instance.</p>
</div>
<div class="paragraph">
<p>The URL is formed from the concatenation of the <code>Api Address</code> (reported by Vault reported by during
<a href="https://developer.hashicorp.com/vault/tutorials/getting-started/getting-started-dev-server#starting-the-dev-server">starts up</a>) with the
complete path to Transit Engine, including the name of the engine itself. If
<a href="https://developer.hashicorp.com/vault/docs/enterprise/namespaces">Namespacing</a> is used on the Vault instance, the path needs to include the
namespace(s). The URL will end with <code>/transit</code> unless the <code>-path</code> parameter was used when
<a href="https://developer.hashicorp.com/vault/docs/secrets/transit#setup">enabling the engine</a>.</p>
</div>
<div class="paragraph">
<p>If namespacing is not in use, the URL will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span>https://myvaultinstance:8200/v1/transit</code></pre>
</div>
</div>
<div class="paragraph">
<p>If namespacing is in use, the path must include the namespaces. For example, if there is a parent namespace is <code>a</code> and
a child namespace is <code>b</code>, the URL will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span>https://myvaultinstance:8200/v1/a/b/transit</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the name of the Transit engine was changed (using the <code>-path</code> argument to the <code>vault secrets enable transit</code> command)
the URL will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span>https://myvaultinstance:8200/v1/mytransit</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_establish_the_naming_convention_for_keys_within_vault_hierarchy"><a class="anchor" href="#_establish_the_naming_convention_for_keys_within_vault_hierarchy"></a><a class="link" href="#_establish_the_naming_convention_for_keys_within_vault_hierarchy">Establish the naming convention for keys within Vault hierarchy</a></h5>
<div class="paragraph">
<p>It is necessary to determine a naming convention for the KEKs within Vault.  This will allow the keys used by the
filter to be kept separate from any keys used by other systems.  This document assumes that the naming convention
will be to prefix the keys used by the filter with the word <code>KEK_</code>.  If a different naming convention is used, adapt
the instructions accordingly.</p>
</div>
</div>
<div class="sect4">
<h5 id="_administrator_actor"><a class="anchor" href="#_administrator_actor"></a><a class="link" href="#_administrator_actor">Administrator Actor</a></h5>
<div class="paragraph">
<p>To use the filter, there must be an administrative actor established.  This actor, which is likely to be a human,
has the responsibility to create keys within Vault for use by the filter.</p>
</div>
<div class="paragraph">
<p>The Administrator must have permissions to log in to Vault and create keys beneath <code>transit/keys/KEK_*</code> in the
Vault hierarchy.</p>
</div>
<div class="paragraph">
<p>The exact steps required to establish an administrative actor will depend on the way that Vault instance has been
<a href="https://developer.hashicorp.com/vault/tutorials/auth-methods">setup</a>.</p>
</div>
<div class="paragraph">
<p>A minimal Vault policy required by the Administrator is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span>path<span class="tok-w"> </span><span class="tok-s2">&quot;transit/keys/KEK_*&quot;</span><span class="tok-w"> </span><span class="tok-o">{</span>
<span class="tok-nv">capabilities</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">[</span><span class="tok-s2">&quot;read&quot;</span>,<span class="tok-w"> </span><span class="tok-s2">&quot;write&quot;</span><span class="tok-o">]</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_filter_actor"><a class="anchor" href="#_filter_actor"></a><a class="link" href="#_filter_actor">Filter Actor</a></h5>
<div class="paragraph">
<p>To use the filter, there must be a Vault identity established for the filter itself.  This identity must have
permissions to perform the operations needed for envelope encryption (generating and decrypting DEKs).</p>
</div>
<div class="paragraph">
<p>Create a Vault policy for the filter actor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span>vault<span class="tok-w"> </span>policy<span class="tok-w"> </span>write<span class="tok-w"> </span>kroxylicious_encryption_filter_policy<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt; EOF</span>
<span class="tok-s">path &quot;transit/keys/KEK_*&quot; {</span>
<span class="tok-s">capabilities = [&quot;read&quot;]</span>
<span class="tok-s">}</span>
<span class="tok-s">path &quot;/transit/datakey/plaintext/KEK_*&quot; {</span>
<span class="tok-s">capabilities = [&quot;update&quot;]</span>
<span class="tok-s">}</span>
<span class="tok-s">path &quot;transit/decrypt/KEK_*&quot; {</span>
<span class="tok-s">capabilities = [ &quot;update&quot;]</span>
<span class="tok-s">}</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a <a href="https://developer.hashicorp.com/vault/docs/concepts/tokens#periodic-tokens">Periodic</a> (long-lived) Vault Token
for the filter<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span>vault<span class="tok-w"> </span>token<span class="tok-w"> </span>create<span class="tok-w"> </span>-display-name<span class="tok-w"> </span><span class="tok-s2">&quot;kroxylicious encryption filter&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">                   </span>-policy<span class="tok-o">=</span>kroxylicious_encryption_filter_policy<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">                   </span>-period<span class="tok-o">=</span>768h<span class="tok-w"> </span><span class="tok-se">\ </span><span class="tok-w">                                    </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">                   </span>-no-default-policy<span class="tok-w"> </span><span class="tok-se">\ </span><span class="tok-w">                              </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">                   </span>-orphan<span class="tok-w">                                            </span><i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Causes the token to be periodic (with every renewal using the given period).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Detach the "default" policy from the policy set for this token.  This is done so the token has least-privilege.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create the token with no parent. This is done so that expiration of a parent won&#8217;t expire the token used by the filter.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>token create</code> command yields the <code>token</code>. The <code>token</code> value is required later when configuring the vault within the
filter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>token              hvs.CAESIFJ_HHo0VnnW6DSbioJ80NqmuYm2WlON-QxAPmiJScZUGh4KHGh2cy5KdkdFZUJMZmhDY0JCSVhnY2JrbUNEWnE
token_accessor     4uQZJbEnxW4YtbDBaW6yVzwP
token_policies     [kroxylicious_encryption_filter_policy]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The token must be <a href="https://developer.hashicorp.com/vault/docs/concepts/tokens#token-time-to-live-periodic-tokens-and-explicit-max-ttls">renewed</a>
before expiration.  It is the responsibility of the Administrator to do this.</p>
</div>
<div class="paragraph">
<p>This can be done with a command like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span>vault<span class="tok-w"> </span>token<span class="tok-w"> </span>renew<span class="tok-w"> </span>--accessor<span class="tok-w"> </span>&lt;token_accessor&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_testing_the_kroxylicious_vault_token_using_the_cli"><a class="anchor" href="#_testing_the_kroxylicious_vault_token_using_the_cli"></a><a class="link" href="#_testing_the_kroxylicious_vault_token_using_the_cli">Testing the Kroxylicious Vault Token using the CLI</a></h5>
<div class="paragraph">
<p>To test whether the Kroxylicious Vault Token and the policy are working correctly, a
<a href="https://raw.githubusercontent.com/kroxylicious/kroxylicious/main/scripts/validate_vault_token.sh">script</a> can be used.</p>
</div>
<div class="paragraph">
<p>First, as an Administrator, create a KEK in the hierarchy at this path <code>transit/keys/KEK_testkey</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span><span class="tok-nv">VAULT_TOKEN</span><span class="tok-o">=</span>&lt;kroxylicious<span class="tok-w"> </span>encryption<span class="tok-w"> </span>filter<span class="tok-w"> </span>token&gt;<span class="tok-w"> </span>validate_vault_token.sh<span class="tok-w"> </span>&lt;kek<span class="tok-w"> </span>path&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The script should respond 'Ok'.  If errors are reported check the policy/token configuration.</p>
</div>
<div class="paragraph">
<p><code>transit/keys/KEK_testkey</code> can now be removed.</p>
</div>
</div>
<div class="sect4">
<h5 id="_filter_configuration"><a class="anchor" href="#_filter_configuration"></a><a class="link" href="#_filter_configuration">Filter Configuration</a></h5>
<div class="paragraph">
<p>The filter is configured as part of the filter chain in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">filters</span><span class="tok-p">:</span>
<span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">EnvelopeEncryption</span><span class="tok-w">                                        </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-nt">config</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">kms</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">&lt;KMS service name&gt;</span><span class="tok-w">                                       </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-nt">kmsConfig</span><span class="tok-p">:</span><span class="tok-w">                                                    </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">      </span><span class="tok-nt">..</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">selector</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">&lt;KEK selector service name&gt;</span><span class="tok-w">                         </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">    </span><span class="tok-nt">selectorConfig</span><span class="tok-p">:</span><span class="tok-w">                                               </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-w">      </span><span class="tok-nt">..</span><span class="tok-p">:</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The name of the filter. This must be <code>EnvelopeEncryption</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The KMS service name.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Object providing configuration understood by KMS provider.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The KEK selector service name.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Object providing configuration understood by key selector.</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="_kms_service_configuration"><a class="anchor" href="#_kms_service_configuration"></a><a class="link" href="#_kms_service_configuration">KMS Service configuration</a></h6>
<div class="paragraph">
<p>In order to configure the KMS Service, follow these KMS provider specific steps.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_hashicorp_vault_2"><a class="anchor" href="#_hashicorp_vault_2"></a><a class="link" href="#_hashicorp_vault_2">HashiCorp Vault</a></h4>
<div class="paragraph">
<p>For HashiCorp Vault, the KMS configuration looks like this.  Use the Vault Token and Vault Transit Engine URL values that
you gathered above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">kms</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">VaultKmsService</span><span class="tok-w">                                          </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nt">kmsConfig</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">vaultTransitEngineUrl</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">&lt;vault transit engine service url&gt;</span><span class="tok-w">   </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">  </span><span class="tok-nt">tls</span><span class="tok-p">:</span><span class="tok-w">                                                        </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">  </span><span class="tok-nt">vaultToken</span><span class="tok-p">:</span><span class="tok-w">                                                 </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">    </span><span class="tok-nt">passwordFile</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/opt/vault/token</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Name of the KMS provider. This must be <code>VaultKmsService</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><a href="setup.adoc#_vault_transit_engine_url">Vault Transit Engine URL</a> including the protocol part, i.e. <code>https:</code> or <code>http:</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>(Optional) TLS trust configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>File containing the Vault Token</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For TLS trust and TLS client authentication configuration, the filter accepts the same TLS parameters as <a href="../../deploying.adoc#_upstream_tls">Upstream TLS</a>
except the <code>PEM</code> store type is currently <a href="https://github.com/kroxylicious/kroxylicious/issues/933">not supported</a>.</p>
</div>
<div class="sect5">
<h6 id="_kek_selector_configuration"><a class="anchor" href="#_kek_selector_configuration"></a><a class="link" href="#_kek_selector_configuration">KEK selector configuration</a></h6>
<div class="paragraph">
<p>The role of the KEK selector is to map from the topic name to key name.  The filter looks up the resulting
key name in the KMS.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the filter is unable to find the key in the KMS, the filter will pass through the
records belonging to that topic in the produce request without encrypting them.
</td>
</tr>
</table>
</div>
<div class="sect6">
<h7 id="_template_kek_selector"><a class="anchor" href="#_template_kek_selector"></a><a class="link" href="#_template_kek_selector">Template KEK Selector</a></h7>
<div class="paragraph">
<p>The <code>TemplateKekSelector</code> maps from topic name to key name.  The template understands the substitution token
<code>${topicName}</code> which is replaced by the name of the topic.  It can be used to build key names
that include the topic name being encrypted.</p>
</div>
<div class="paragraph">
<p>Use the <code>${topicName}</code> is optional. It is possible to pass a literal string.  This will result in all topics being
encrypted using the same key.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">selector</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">TemplateKekSelector</span><span class="tok-w">                                 </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nt">selectorConfig</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;KEK_${topicName}&quot;</span><span class="tok-w">                                </span><i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The name of the KEK selector. This must be <code>TemplateKekSelector</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Template used to build the key name from the topic name.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_establishing_the_keys_in_the_kms"><a class="anchor" href="#_establishing_the_keys_in_the_kms"></a><a class="link" href="#_establishing_the_keys_in_the_kms">Establishing the keys in the KMS</a></h5>
<div class="paragraph">
<p>It is the role of the Administrator to create KEKs in the KMS that will be used to
encrypt the records.  This must be done using whatever management interface the KMS provides.</p>
</div>
<div class="paragraph">
<p>The names (or aliases) of the encryption keys must match the naming conventions established above.  If the selector
generates a key name that doesn&#8217;t exist within the KMS, records will be sent to the topic without encryption.</p>
</div>
<div class="paragraph">
<p>For example, if using the <code>TemplateKekSelector</code> with the template <code>KEK_${topicName}</code>, create a key for every topic that
is to be encrypted with the key name matching the topic name, prefixed by the string <code>KEK_</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_hashicorp_vault_3"><a class="anchor" href="#_hashicorp_vault_3"></a><a class="link" href="#_hashicorp_vault_3">HashiCorp Vault</a></h4>
<div class="paragraph">
<p>Using the Administrator actor, use either the HashiCorp UI or CLI to create AES-256 symmetric keys following your
key naming convention. The key type must be <code>aes256-gcm96</code>, which is Vault&#8217;s default key type.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It is recommended to use a key rotation policy.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If using the Vault CLI, the command will look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span>vault<span class="tok-w"> </span>write<span class="tok-w"> </span>-f<span class="tok-w"> </span>transit/keys/KEK_trades<span class="tok-w"> </span><span class="tok-nv">type</span><span class="tok-o">=</span>aes256-gcm96<span class="tok-w"> </span><span class="tok-nv">auto_rotate_period</span><span class="tok-o">=</span>90d</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_verifying_that_encryption_is_occurring"><a class="anchor" href="#_verifying_that_encryption_is_occurring"></a><a class="link" href="#_verifying_that_encryption_is_occurring">Verifying that encryption is occurring</a></h5>
<div class="paragraph">
<p>To verify that records sent to topics are indeed being encrypted, use <code>kafka-console-consumer</code> to consume the
records <strong>directly from the target Kafka Cluster</strong>.  Verify that encrypted text is seen rather than whatever plain text
that was sent by producer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>kafka-console-consumer --bootstrap-server mycluster:8092 --topic trades --from-beginning</code></pre>
</div>
</div>
<div class="paragraph">
<p>The record values seen will look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>tradesvault:v1:+EfJ977UG1XkjI9yh7vxpgN2E1DKaIkDuxE+eCprVTKr+sskFuChcTe/KpR/c8ZDyP76W3itExmEzLOl����x)�Ũ�z�:S�������tБ��v���</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_multi_tenancy"><a class="anchor" href="#_multi_tenancy"></a><a class="link" href="#_multi_tenancy">Multi-tenancy</a></h3>

</div>
<div class="sect2">
<h3 id="_schema_validation"><a class="anchor" href="#_schema_validation"></a><a class="link" href="#_schema_validation">Schema-validation</a></h3>

</div>
<div class="sect2">
<h3 id="_community_filters"><a class="anchor" href="#_community_filters"></a><a class="link" href="#_community_filters">Community filters</a></h3>
<div class="paragraph">
<p>Community contributed filters are showcased in the
<a href="https://github.com/kroxylicious/kroxylicious-community-gallery">Community Gallery</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_custom_filters"><a class="anchor" href="#_custom_filters"></a><a class="link" href="#_custom_filters">Custom Filters</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Custom filters can be written in the Java programming language.
Knowledge of the <a href="https://kafka.apache.org/protocol.html">Kafka protocol</a> is generally required to write a protocol filter.</p>
</div>
<div class="paragraph">
<p>There is currently one class of Custom Filters users can implement:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="#_protocol_filters">Protocol filters</a></dt>
<dd>
<p>Allow customisation of how protocol messages are handled on their way to, or from, the Cluster.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The following sections explain in more detail how to write your own filters.</p>
</div>
<div class="sect2">
<h3 id="_sample_custom_filter_project"><a class="anchor" href="#_sample_custom_filter_project"></a><a class="link" href="#_sample_custom_filter_project">Sample Custom Filter Project</a></h3>
<div class="paragraph">
<p>A collection of sample filters is available within the Kroxylicious repository for you to download, try out, and customise.
You can find them <a href="https://github.com/kroxylicious/kroxylicious/tree/main/kroxylicious-sample">here</a> for a hands-on introduction to creating your own custom filters.</p>
</div>
</div>
<div class="sect2">
<h3 id="_api_docs"><a class="anchor" href="#_api_docs"></a><a class="link" href="#_api_docs">API docs</a></h3>
<div class="paragraph">
<p>Custom Protocol Filters are built by implementing interfaces supplied by the
<a href="https://github.com/kroxylicious/kroxylicious/tree/main/api/kroxylicious-api">kroxylicious-api</a> module
(<a href="https://mvnrepository.com/artifact/io.kroxylicious/kroxylicious-api">io.kroxylicious:kroxylicious-api</a> on
maven central). You can view the javadoc <a href="https://javadoc.io/doc/io.kroxylicious/kroxylicious-api/latest/io/kroxylicious/proxy/filter/package-summary.html">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_dependencies"><a class="anchor" href="#_dependencies"></a><a class="link" href="#_dependencies">Dependencies</a></h3>
<div class="paragraph">
<p>How filter classes are loaded is not currently defined by the filter contract.
In other words, filters might be loaded using a classloader-per-filter model,
or using a single class loader.
This doesn&#8217;t really make a difference to filter authors except where they want to make use of libraries as dependencies.
Because those dependencies might be loaded by the same classloader as the dependencies of other filters there is the possibility of collision. Filter A and Filter B might both want to use Library C, and they might want to use different versions of Library C.</p>
</div>
<div class="paragraph">
<p>For common things like logging and metric facade APIs it is recommended to use the facade APIs which are also used by the proxy core.</p>
</div>
</div>
<div class="sect2">
<h3 id="_protocol_filters"><a class="anchor" href="#_protocol_filters"></a><a class="link" href="#_protocol_filters">Protocol filters</a></h3>
<div class="paragraph">
<p>A protocol filter is a <code>public</code> top-level, concrete class with a particular public constructor and which implements
one or more protocol filter interfaces. You can implement two distinct types of Custom Protocol Filter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_specific_message_protocol_filters">Specific Message Protocol Filters</a></p>
</li>
<li>
<p><a href="#_requestresponse_protocol_filters">Request/Response Protocol Filters</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that these types are mutually exclusive, for example a Filter is not allowed to implement both <code>RequestFilter</code> and
<code>MetadataRequestFilter</code>. This is to prevent ambiguity. If we received a <code>MetadataRequest</code>, would it be dispatched to
the <code>onMetadataRequest(..)</code> method of <code>MetadataRequestFilter</code> or the <code>onRequest</code> method of <code>RequestFilter</code>, or both?
Instead, we disallow these combinations, throwing an exception at runtime if your Filter implements incompatible interfaces.</p>
</div>
<div class="sect3">
<h4 id="_specific_message_protocol_filters"><a class="anchor" href="#_specific_message_protocol_filters"></a><a class="link" href="#_specific_message_protocol_filters">Specific Message Protocol Filters</a></h4>
<div class="paragraph">
<p>A filter may wish to intercept specific types of Kafka messages. For example, intercept all Produce Requests, or
intercept all Fetch Responses. To support this case Kroxylicious provides an interfaces for all request types and
response types supported by Kafka (at the version of Kafka Kroxylicious depends on). A filter implementation can
implement any combination of these interfaces.</p>
</div>
<div class="paragraph">
<p>There is no requirement that a Filter handles both the request and response halves of an RPC. A Filter can choose to
intercept only the request, or only the response, or both the request and response.</p>
</div>
<div class="sect4">
<h5 id="_examples"><a class="anchor" href="#_examples"></a><a class="link" href="#_examples">Examples</a></h5>
<div class="paragraph">
<p>To intercept all Fetch Requests your class would implement
<a href="https://javadoc.io/doc/io.kroxylicious/kroxylicious-api/latest/io/kroxylicious/proxy/filter/FetchRequestFilter.html">FetchRequestFilter</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">FetchRequestClientIdFilter</span><span class="tok-w"> </span><span class="tok-kd">implements</span><span class="tok-w"> </span><span class="tok-n">FetchRequestFilter</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-nd">@Override</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">CompletionStage</span><span class="tok-o">&lt;</span><span class="tok-n">RequestFilterResult</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-nf">onFetchRequest</span><span class="tok-p">(</span><span class="tok-kt">short</span><span class="tok-w"> </span><span class="tok-n">apiVersion</span><span class="tok-p">,</span>
<span class="tok-w">                                                               </span><span class="tok-n">RequestHeaderData</span><span class="tok-w"> </span><span class="tok-n">header</span><span class="tok-p">,</span>
<span class="tok-w">                                                               </span><span class="tok-n">FetchRequestData</span><span class="tok-w"> </span><span class="tok-n">request</span><span class="tok-p">,</span>
<span class="tok-w">                                                               </span><span class="tok-n">FilterContext</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">header</span><span class="tok-p">.</span><span class="tok-na">setClientId</span><span class="tok-p">(</span><span class="tok-s">&quot;fetch-client!&quot;</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">.</span><span class="tok-na">forwardRequest</span><span class="tok-p">(</span><span class="tok-n">header</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">request</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To intercept all Fetch Responses your class would implement
<a href="https://javadoc.io/doc/io.kroxylicious/kroxylicious-api/latest/io/kroxylicious/proxy/filter/FetchResponseFilter.html">FetchResponseFilter</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">FetchRequestClientIdFilter</span><span class="tok-w"> </span><span class="tok-kd">implements</span><span class="tok-w"> </span><span class="tok-n">FetchResponseFilter</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-nd">@Override</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">CompletionStage</span><span class="tok-o">&lt;</span><span class="tok-n">ResponseFilterResult</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-nf">onFetchResponse</span><span class="tok-p">(</span><span class="tok-kt">short</span><span class="tok-w"> </span><span class="tok-n">apiVersion</span><span class="tok-p">,</span>
<span class="tok-w">                                                                 </span><span class="tok-n">ResponseHeaderData</span><span class="tok-w"> </span><span class="tok-n">header</span><span class="tok-p">,</span>
<span class="tok-w">                                                                 </span><span class="tok-n">FetchResponseData</span><span class="tok-w"> </span><span class="tok-n">response</span><span class="tok-p">,</span>
<span class="tok-w">                                                                 </span><span class="tok-n">FilterContext</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">mutateResponse</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">.</span><span class="tok-na">forwardResponse</span><span class="tok-p">(</span><span class="tok-n">header</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">response</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To intercept all Fetch Requests and all Fetch Responses your class would implement
<a href="https://javadoc.io/doc/io.kroxylicious/kroxylicious-api/latest/io/kroxylicious/proxy/filter/FetchRequestFilter.html">FetchRequestFilter</a> and
<a href="https://javadoc.io/doc/io.kroxylicious/kroxylicious-api/latest/io/kroxylicious/proxy/filter/FetchResponseFilter.html">FetchResponseFilter</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">FetchRequestClientIdFilter</span><span class="tok-w"> </span><span class="tok-kd">implements</span><span class="tok-w"> </span><span class="tok-n">FetchRequestFilter</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">FetchResponseFilter</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-nd">@Override</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">CompletionStage</span><span class="tok-o">&lt;</span><span class="tok-n">RequestFilterResult</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-nf">onFetchRequest</span><span class="tok-p">(</span><span class="tok-kt">short</span><span class="tok-w"> </span><span class="tok-n">apiVersion</span><span class="tok-p">,</span>
<span class="tok-w">                                                               </span><span class="tok-n">RequestHeaderData</span><span class="tok-w"> </span><span class="tok-n">header</span><span class="tok-p">,</span>
<span class="tok-w">                                                               </span><span class="tok-n">FetchRequestData</span><span class="tok-w"> </span><span class="tok-n">request</span><span class="tok-p">,</span>
<span class="tok-w">                                                               </span><span class="tok-n">FilterContext</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">header</span><span class="tok-p">.</span><span class="tok-na">setClientId</span><span class="tok-p">(</span><span class="tok-s">&quot;fetch-client!&quot;</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">.</span><span class="tok-na">forwardRequest</span><span class="tok-p">(</span><span class="tok-n">header</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">request</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-nd">@Override</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">CompletionStage</span><span class="tok-o">&lt;</span><span class="tok-n">ResponseFilterResult</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-nf">onFetchResponse</span><span class="tok-p">(</span><span class="tok-kt">short</span><span class="tok-w"> </span><span class="tok-n">apiVersion</span><span class="tok-p">,</span>
<span class="tok-w">                                                                 </span><span class="tok-n">ResponseHeaderData</span><span class="tok-w"> </span><span class="tok-n">header</span><span class="tok-p">,</span>
<span class="tok-w">                                                                 </span><span class="tok-n">FetchResponseData</span><span class="tok-w"> </span><span class="tok-n">response</span><span class="tok-p">,</span>
<span class="tok-w">                                                                 </span><span class="tok-n">FilterContext</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">mutateResponse</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">.</span><span class="tok-na">forwardResponse</span><span class="tok-p">(</span><span class="tok-n">header</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">response</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Specific Message Filter interfaces are mutually exclusive with <a href="#_requestresponse_protocol_filters">Request/Response</a>.
Kroxylicious will reject invalid combinations of interfaces.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_requestresponse_protocol_filters"><a class="anchor" href="#_requestresponse_protocol_filters"></a><a class="link" href="#_requestresponse_protocol_filters">Request/Response Protocol Filters</a></h4>
<div class="paragraph">
<p>A filter may wish to intercept every message being sent from the Client to the Cluster or from the Cluster
to the Client. To do this your custom filter will implement:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://javadoc.io/doc/io.kroxylicious/kroxylicious-api/latest/io/kroxylicious/proxy/filter/RequestFilter.html">RequestFilter</a>
to intercept all requests.</p>
</li>
<li>
<p><a href="https://javadoc.io/doc/io.kroxylicious/kroxylicious-api/latest/io/kroxylicious/proxy/filter/ResponseFilter.html">ResponseFilter</a>
to intercept all responses.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Custom filters are free to implement either interface or both interfaces to intercept all messages.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">FixedClientIdFilter</span><span class="tok-w"> </span><span class="tok-kd">implements</span><span class="tok-w"> </span><span class="tok-n">RequestFilter</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-nd">@Override</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">CompletionStage</span><span class="tok-o">&lt;</span><span class="tok-n">RequestFilterResult</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-nf">onRequest</span><span class="tok-p">(</span><span class="tok-n">ApiKeys</span><span class="tok-w"> </span><span class="tok-n">apiKey</span><span class="tok-p">,</span>
<span class="tok-w">                                                          </span><span class="tok-n">RequestHeaderData</span><span class="tok-w"> </span><span class="tok-n">header</span><span class="tok-p">,</span>
<span class="tok-w">                                                          </span><span class="tok-n">ApiMessage</span><span class="tok-w"> </span><span class="tok-n">body</span><span class="tok-p">,</span>
<span class="tok-w">                                                          </span><span class="tok-n">FilterContext</span><span class="tok-w"> </span><span class="tok-n">filterContext</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">header</span><span class="tok-p">.</span><span class="tok-na">setClientId</span><span class="tok-p">(</span><span class="tok-s">&quot;example!&quot;</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">filterContext</span><span class="tok-p">.</span><span class="tok-na">forwardRequest</span><span class="tok-p">(</span><span class="tok-n">header</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">body</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Request/Response Filter interfaces are mutually exclusive with <a href="#_specific_message_protocol_filters">Specific Message</a> interfaces.
Kroxylicious will reject invalid combinations of interfaces.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_filter_result"><a class="anchor" href="#_the_filter_result"></a><a class="link" href="#_the_filter_result">The Filter Result</a></h4>
<div class="paragraph">
<p>As seen above, filter methods (<code>onXyz[Request|Response]</code>) must return a <code>CompletionStage&lt;FilterResult&gt;</code> object.
It is the job of <code>FilterResult</code> to convey what message is to forwarded to the next filter in the chain (or broker
/client if at the chain&#8217;s beginning or end).  It is also used to carry instructions such as indicating that the
connection must be closed, or a message dropped.</p>
</div>
<div class="paragraph">
<p>If the filter returns a <code>CompletionStage</code> that is already completed normally, Kroxylicious will immediately perform
the action described by the <code>FilterResult</code>.</p>
</div>
<div class="paragraph">
<p>The filter may return a <code>CompletionStage</code> that is not yet completed. When this happens, Kroxylicious will pause
reading from the downstream (the Client writes will eventually block), and it begins to queue up in-flight
requests/responses arriving at the filter.  This is done so that message order is maintained.  Once the
<code>CompletionStage</code> completes, the action described  by the <code>FilterResult</code> is performed, reading from the downstream
resumes and any queued up requests/responses are processed.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The pausing of reads from the downstream is a relatively costly operation.  To maintain optimal performance
filter implementations should minimise the occasions on which an incomplete <code>CompletionStage</code> is returned.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the <code>CompletionStage</code> completes exceptionally, the connection is closed.  This also applies if the
<code>CompletionStage</code> does not complete within a timeout (20000 milliseconds).</p>
</div>
<div class="sect4">
<h5 id="_creating_a_filter_result"><a class="anchor" href="#_creating_a_filter_result"></a><a class="link" href="#_creating_a_filter_result">Creating a Filter Result</a></h5>
<div class="paragraph">
<p>The <code>FilterContext</code> is the factory for the <code>FilterResult</code> objects.</p>
</div>
<div class="paragraph">
<p>There are two convenience methods<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> that simply allow a filter to forward a result to the next filter.
We&#8217;ve already seen  these in action above.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>context.forwardRequest(header, request)</code> used by result filter to forward a request.</p>
</li>
<li>
<p><code>context.forwardResponse(header, response)</code> used by result filter to forward a request.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To access richer features, use the filter result builders <code>context.requestFilterResultBuilder()</code> and
<code>responseFilterResultBuilder()</code>.</p>
</div>
<div class="paragraph">
<p>Filter result builders allow you to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>forward a request/response: <code>.forward(header, request)</code>.</p>
</li>
<li>
<p>signal that a connection is to be closed: <code>.withCloseConnection()</code>.</p>
</li>
<li>
<p>signal that a message is to be dropped (i.e. not forwarded): <code>.drop()</code>.</p>
</li>
<li>
<p>for requests only, send a short-circuit response: <code>.shortCircuitResponse(header, response)</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The builder lets you combine legal behaviours together.  For instance, to close the connection after forwarding
a response to a client, a response filter could use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">return context.responseFilterResultBuilder()</span>
<span class="tok-w">        </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">.forward(header, response)</span>
<span class="tok-w">        </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">.withCloseConnection()</span>
<span class="tok-w">        </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">.complete();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The builders yield either a completed <code>CompletionStage&lt;FilterResult&gt;</code> which can be returned directly from the
filter method, or bare <code>FilterResult</code>.  The latter exists to support asynchronous programming styles allowing you
to use your own Futures.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The <code>drop</code> behaviour can be legally used in very specific circumstances.  The Kafka Protocol is,
for the most part, strictly request/response with responses expected in the order the request were sent.  The client
will fail if the contract isn&#8217;t upheld.  The exception is <code>Produce</code> where <code>acks=0</code>.  Filters may drop these requests without
introducing a protocol error.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_protocol_filter_lifecycle"><a class="anchor" href="#_the_protocol_filter_lifecycle"></a><a class="link" href="#_the_protocol_filter_lifecycle">The protocol filter lifecycle</a></h4>
<div class="paragraph">
<p>Instances of the filter class are created on demand when a protocol message is first sent by a client.
Instances are specific to the channel between a single client and a single broker.</p>
</div>
<div class="paragraph">
<p>It exists while the client remains connected.</p>
</div>
</div>
<div class="sect3">
<h4 id="_handling_state"><a class="anchor" href="#_handling_state"></a><a class="link" href="#_handling_state">Handling state</a></h4>
<div class="paragraph">
<p>The simplest way of managing per-client state is to use member fields.
The proxy guarantees that all methods of a given filter instance will always be invoked on the same thread (also true of
the CompletionStage completion in the case of <a href="#_sending_asynchronous_requests_to_the_cluster">Sending asynchronous requests to the Cluster</a>).
Therefore, there is no need to use synchronization when accessing such fields.</p>
</div>
<div class="paragraph">
<p>See the <a href="https://javadoc.io/doc/io.kroxylicious/kroxylicious-api/latest/io/kroxylicious/proxy/filter/package-summary.html#implementing.threadSafety"><code>io.kroxylicious.proxy.filter</code></a>
package javadoc for more information on thread-safety.</p>
</div>
</div>
<div class="sect3">
<h4 id="_filter_patterns"><a class="anchor" href="#_filter_patterns"></a><a class="link" href="#_filter_patterns">Filter Patterns</a></h4>
<div class="paragraph">
<p>Kroxylicious Protocol Filters support several patterns:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#_intercepting_requests_and_responses">Intercepting Requests and Responses</a></p>
</li>
<li>
<p><a href="#_sending_response_messages_from_a_request_filter_towards_the_client_short_circuit_responses">Sending Response messages from a Request Filter towards the Client (Short-circuit responses)</a></p>
</li>
<li>
<p><a href="#_sending_asynchronous_requests_to_the_cluster">Sending asynchronous requests to the Cluster</a></p>
</li>
<li>
<p><a href="#_filtering_specific_api_versions">Filtering specific API Versions</a></p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_intercepting_requests_and_responses"><a class="anchor" href="#_intercepting_requests_and_responses"></a><a class="link" href="#_intercepting_requests_and_responses">Intercepting Requests and Responses</a></h5>
<div class="paragraph">
<p>This is a common pattern, we want to inspect or modify a message. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">SampleFetchResponseFilter</span><span class="tok-w"> </span><span class="tok-kd">implements</span><span class="tok-w"> </span><span class="tok-n">FetchResponseFilter</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nd">@Override</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">CompletionStage</span><span class="tok-o">&lt;</span><span class="tok-n">ResponseFilterResult</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-nf">onFetchResponse</span><span class="tok-p">(</span><span class="tok-kt">short</span><span class="tok-w"> </span><span class="tok-n">apiVersion</span><span class="tok-p">,</span>
<span class="tok-w">                                                                 </span><span class="tok-n">ResponseHeaderData</span><span class="tok-w"> </span><span class="tok-n">header</span><span class="tok-p">,</span>
<span class="tok-w">                                                                 </span><span class="tok-n">FetchResponseData</span><span class="tok-w"> </span><span class="tok-n">response</span><span class="tok-p">,</span>
<span class="tok-w">                                                                 </span><span class="tok-n">FilterContext</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">mutateResponse</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">);</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">.</span><span class="tok-na">forwardResponse</span><span class="tok-p">(</span><span class="tok-n">header</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">response</span><span class="tok-p">);</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We mutate the response object. For example, you could alter the records that have been fetched.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We forward the response, sending it towards the client, invoking Filters downstream of this one.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We can only forward the response and header objects passed into the <code>onFetchResponse</code>. New instances are not
supported.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_sending_response_messages_from_a_request_filter_towards_the_client_short_circuit_responses"><a class="anchor" href="#_sending_response_messages_from_a_request_filter_towards_the_client_short_circuit_responses"></a><a class="link" href="#_sending_response_messages_from_a_request_filter_towards_the_client_short_circuit_responses">Sending Response messages from a Request Filter towards the Client (Short-circuit responses)</a></h5>
<div class="paragraph">
<p>In some cases we may wish to not forward a request from the client to the Cluster. Instead, we want to intercept that
request and generate a response message in a Kroxylicious Protocol Filter and send it towards the client.  This is called
a short-circuit response.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="diag-a2s-md5-a2f2453658c2a9ed0aa565e848f7ee8e.svg" alt="Diagram" width="1089" height="368">
</div>
<div class="title">Figure 5. Illustration of responding without proxying</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">CreateTopicRejectFilter</span><span class="tok-w"> </span><span class="tok-kd">implements</span><span class="tok-w"> </span><span class="tok-n">CreateTopicsRequestFilter</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">CompletionStage</span><span class="tok-o">&lt;</span><span class="tok-n">RequestFilterResult</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-nf">onCreateTopicsRequest</span><span class="tok-p">(</span><span class="tok-kt">short</span><span class="tok-w"> </span><span class="tok-n">apiVersion</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">RequestHeaderData</span><span class="tok-w"> </span><span class="tok-n">header</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">CreateTopicsRequestData</span><span class="tok-w"> </span><span class="tok-n">request</span><span class="tok-p">,</span>
<span class="tok-w">                                                                      </span><span class="tok-n">FilterContext</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">CreateTopicsResponseData</span><span class="tok-w"> </span><span class="tok-n">response</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">CreateTopicsResponseData</span><span class="tok-p">();</span>
<span class="tok-w">        </span><span class="tok-n">CreateTopicsResponseData</span><span class="tok-p">.</span><span class="tok-na">CreatableTopicResultCollection</span><span class="tok-w"> </span><span class="tok-n">topics</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">CreateTopicsResponseData</span><span class="tok-p">.</span><span class="tok-na">CreatableTopicResultCollection</span><span class="tok-p">();</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">        </span><span class="tok-n">request</span><span class="tok-p">.</span><span class="tok-na">topics</span><span class="tok-p">().</span><span class="tok-na">forEach</span><span class="tok-p">(</span><span class="tok-n">creatableTopic</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">CreateTopicsResponseData</span><span class="tok-p">.</span><span class="tok-na">CreatableTopicResult</span><span class="tok-w"> </span><span class="tok-n">result</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">CreateTopicsResponseData</span><span class="tok-p">.</span><span class="tok-na">CreatableTopicResult</span><span class="tok-p">();</span>
<span class="tok-w">            </span><span class="tok-n">result</span><span class="tok-p">.</span><span class="tok-na">setErrorCode</span><span class="tok-p">(</span><span class="tok-n">Errors</span><span class="tok-p">.</span><span class="tok-na">INVALID_TOPIC_EXCEPTION</span><span class="tok-p">.</span><span class="tok-na">code</span><span class="tok-p">()).</span><span class="tok-na">setErrorMessage</span><span class="tok-p">(</span><span class="tok-n">ERROR_MESSAGE</span><span class="tok-p">);</span>
<span class="tok-w">            </span><span class="tok-n">result</span><span class="tok-p">.</span><span class="tok-na">setName</span><span class="tok-p">(</span><span class="tok-n">creatableTopic</span><span class="tok-p">.</span><span class="tok-na">name</span><span class="tok-p">());</span>
<span class="tok-w">            </span><span class="tok-n">topics</span><span class="tok-p">.</span><span class="tok-na">add</span><span class="tok-p">(</span><span class="tok-n">result</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-p">});</span>
<span class="tok-w">        </span><span class="tok-n">response</span><span class="tok-p">.</span><span class="tok-na">setTopics</span><span class="tok-p">(</span><span class="tok-n">topics</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">.</span><span class="tok-na">requestFilterResultBuilder</span><span class="tok-p">().</span><span class="tok-na">shortCircuitResponse</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">).</span><span class="tok-na">completed</span><span class="tok-p">();</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a new instance of the corresponding response data and populate it. Note you may need to use the <code>apiVersion</code>
to check which fields can be set at this request&#8217;s API version.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We generate a short-circuit response that will send it towards the client, invoking Filters downstream of this one.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This will respond to all Create Topic requests with an error response without forwarding any of those requests to the Cluster.</p>
</div>
<div class="sect5">
<h6 id="_closing_the_connections"><a class="anchor" href="#_closing_the_connections"></a><a class="link" href="#_closing_the_connections">Closing the connections</a></h6>
<div class="paragraph">
<p>There is a useful variation on the pattern above, where the filter needs, in addition to sending an error
response, also to cause the connection to close.  This is useful in use-cases where the filter wishes to disallow
certain client behaviours.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">DisallowAlterConfigs</span><span class="tok-w"> </span><span class="tok-kd">implements</span><span class="tok-w"> </span><span class="tok-n">AlterConfigsRequestFilter</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-nd">@Override</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">CompletionStage</span><span class="tok-o">&lt;</span><span class="tok-n">RequestFilterResult</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-nf">onAlterConfigsRequest</span><span class="tok-p">(</span><span class="tok-kt">short</span><span class="tok-w"> </span><span class="tok-n">apiVersion</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">RequestHeaderData</span><span class="tok-w"> </span><span class="tok-n">header</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">AlterConfigsRequestData</span><span class="tok-w"> </span><span class="tok-n">request</span><span class="tok-p">,</span>
<span class="tok-w">                                                                      </span><span class="tok-n">FilterContext</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-n">response</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">AlterConfigsResponseData</span><span class="tok-p">();</span>
<span class="tok-w">        </span><span class="tok-n">response</span><span class="tok-p">.</span><span class="tok-na">setResponses</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">.</span><span class="tok-na">resources</span><span class="tok-p">().</span><span class="tok-na">stream</span><span class="tok-p">()</span>
<span class="tok-w">                </span><span class="tok-p">.</span><span class="tok-na">map</span><span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">AlterConfigsResourceResponse</span><span class="tok-p">()</span>
<span class="tok-w">                        </span><span class="tok-p">.</span><span class="tok-na">setErrorCode</span><span class="tok-p">(</span><span class="tok-n">Errors</span><span class="tok-p">.</span><span class="tok-na">INVALID_CONFIG</span><span class="tok-p">.</span><span class="tok-na">code</span><span class="tok-p">())</span>
<span class="tok-w">                        </span><span class="tok-p">.</span><span class="tok-na">setErrorMessage</span><span class="tok-p">(</span><span class="tok-s">&quot;This service does not allow this operation - closing connection&quot;</span><span class="tok-p">))</span>
<span class="tok-w">                </span><span class="tok-p">.</span><span class="tok-na">toList</span><span class="tok-p">());</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">.</span><span class="tok-na">requestFilterResultBuilder</span><span class="tok-p">()</span>
<span class="tok-w">                         </span><span class="tok-p">.</span><span class="tok-na">shortCircuitResponse</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">)</span>
<span class="tok-w">                         </span><span class="tok-p">.</span><span class="tok-na">withCloseConnection</span><span class="tok-p">()</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">                         </span><span class="tok-p">.</span><span class="tok-na">completed</span><span class="tok-p">();</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We enable the close connection option on the builder.  This will cause Kroxylicious to close the connection
after the response is sent to the client.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_sending_asynchronous_requests_to_the_cluster"><a class="anchor" href="#_sending_asynchronous_requests_to_the_cluster"></a><a class="link" href="#_sending_asynchronous_requests_to_the_cluster">Sending asynchronous requests to the Cluster</a></h5>
<div class="paragraph">
<p>Filters can make additional asynchronous requests to the Cluster.  This is useful if the Filter needs additional
information from the Cluster in order to know how to mutate the filtered request/response.</p>
</div>
<div class="paragraph">
<p>The Filter can make use of <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/CompletionStage.html">CompletionStage</a>
chaining features ([<code>#thenApply()</code> etc.) to organise for actions to be done once the asynchronous request completes.
For example, it could chain an action that mutates the filtered request/response using the asynchronous response, and
finally, chain an action to forward the request/response to the next filter.</p>
</div>
<div class="paragraph">
<p>The asynchronous request/response will be intercepted by Filters upstream of this Filter.  Filters downstream of this
Filter (and the Client) do not see the asynchronous response.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at an example. We&#8217;ll send an asynchronous request towards the Cluster for topic metadata while
handling a FetchRequest and use the response to mutate the FetchRequest before passing it to the next filter in the chain.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">FetchFilter</span><span class="tok-w"> </span><span class="tok-kd">implements</span><span class="tok-w"> </span><span class="tok-n">FetchRequestFilter</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">static</span><span class="tok-w"> </span><span class="tok-kd">final</span><span class="tok-w"> </span><span class="tok-kt">short</span><span class="tok-w"> </span><span class="tok-n">METADATA_VERSION_SUPPORTING_TOPIC_IDS</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">short</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-mi">12</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-nd">@Override</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">CompletionStage</span><span class="tok-o">&lt;</span><span class="tok-n">RequestFilterResult</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-nf">onFetchRequest</span><span class="tok-p">(</span><span class="tok-n">ApiKeys</span><span class="tok-w"> </span><span class="tok-n">apiKey</span><span class="tok-p">,</span>
<span class="tok-w">                                                               </span><span class="tok-n">RequestHeaderData</span><span class="tok-w"> </span><span class="tok-n">header</span><span class="tok-p">,</span>
<span class="tok-w">                                                               </span><span class="tok-n">FetchRequestData</span><span class="tok-w"> </span><span class="tok-n">request</span><span class="tok-p">,</span>
<span class="tok-w">                                                               </span><span class="tok-n">FilterContext</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-n">metadataRequestHeader</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">RequestHeaderData</span><span class="tok-p">().</span><span class="tok-na">setRequestApiVersion</span><span class="tok-p">(</span><span class="tok-n">METADATA_VERSION_SUPPORTING_TOPIC_IDS</span><span class="tok-p">);</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">        </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-n">metadataRequest</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">MetadataRequestData</span><span class="tok-p">();</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">        </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-n">topic</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">new</span><span class="tok-w"> </span><span class="tok-n">MetadataRequestData</span><span class="tok-p">.</span><span class="tok-na">MetadataRequestTopic</span><span class="tok-p">();</span>
<span class="tok-w">        </span><span class="tok-n">topic</span><span class="tok-p">.</span><span class="tok-na">setTopicId</span><span class="tok-p">(</span><span class="tok-n">Uuid</span><span class="tok-p">.</span><span class="tok-na">randomUuid</span><span class="tok-p">());</span>
<span class="tok-w">        </span><span class="tok-n">metadataRequest</span><span class="tok-p">.</span><span class="tok-na">topics</span><span class="tok-p">().</span><span class="tok-na">add</span><span class="tok-p">(</span><span class="tok-n">topic</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-kd">var</span><span class="tok-w"> </span><span class="tok-n">stage</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">.</span><span class="tok-na">sendRequest</span><span class="tok-p">(</span><span class="tok-n">metadataRequestHeader</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">metadataRequest</span><span class="tok-p">);</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">stage</span><span class="tok-p">.</span><span class="tok-na">thenApply</span><span class="tok-p">(</span><span class="tok-n">metadataResponse</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><span class="tok-n">mutateFetchRequest</span><span class="tok-p">(</span><span class="tok-n">metadataResponse</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">request</span><span class="tok-p">))</span><span class="tok-w"> </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">                    </span><span class="tok-p">.</span><span class="tok-na">thenCompose</span><span class="tok-p">(</span><span class="tok-n">mutatedFetchRequest</span><span class="tok-w"> </span><span class="tok-o">-&gt;</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">.</span><span class="tok-na">forwardRequest</span><span class="tok-p">(</span><span class="tok-n">header</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">mutatedFetchRequest</span><span class="tok-p">));</span><span class="tok-w"> </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We construct a header object for the asynchronous request.  It is important to specify the API version of the request
that is to be used.  The version chosen must be a version known to the Kafka Client used by Kroxylicious
and must be an API version supported by the Target Cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We construct a new request object. When constructing the request object, care needs to be taken to ensure the request is populated with the structure which matches the API version you have chosen.  Refer to the <a href="https://kafka.apache.org/protocol.html">Kafka Protocol Guide</a> for more details.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We asynchronously send the request towards the Cluster and obtain a CompletionStage which will contain the response.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We use a computation stage to mutate the filtered fetch request using the response from the request sent at &lt;3&gt;.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We use another computation stage to forward the mutated request.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you have read above, we need to know the API version we want our request to be encoded at. Your filter can discover
what versions of an API the Kafka Cluster supports.  To do this use the
<a href="https://javadoc.io/doc/io.kroxylicious/kroxylicious-api/latest/io/kroxylicious/proxy/ApiVersionsService.html">ApiVersionsService</a> available from the <code>FilterContext</code>
to determine programmatically what versions of an API are support and then write code to make a suitable <code>request</code>
object.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Kroxylicious provides the guarantee that computation stages chained using the <em>default execution methods</em> are
executed on the same thread as the rest of the Filter work, so we can safely mutate Filter members without synchronising.
See the <a href="https://javadoc.io/doc/io.kroxylicious/kroxylicious-api/latest/io/kroxylicious/proxy/filter/package-summary.html#implementing.threadSafety"><code>io.kroxylicious.proxy.filter</code></a>
package javadoc for more information on thread-safety.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_filtering_specific_api_versions"><a class="anchor" href="#_filtering_specific_api_versions"></a><a class="link" href="#_filtering_specific_api_versions">Filtering specific API Versions</a></h5>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Kafka has a "bidirectional" client compatibility policy. In other words, new clients can talk to old servers, and old clients can talk to new servers. This allows users to upgrade either clients or servers without experiencing any downtime.</p>
</div>
<div class="paragraph">
<p>Since the Kafka protocol has changed over time, clients and servers need to agree on the schema of the message that they are sending over the wire. This is done through API versioning.</p>
</div>
<div class="paragraph">
<p>Before each request is sent, the client sends the API key and the API version. These two 16-bit numbers, when taken together, uniquely identify the schema of the message to follow.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; <a href="https://kafka.apache.org/protocol.html#protocol_compatibility" class="bare">https://kafka.apache.org/protocol.html#protocol_compatibility</a>
</div>
</div>
<div class="paragraph">
<p>You may wish to restrict your Filter to only apply to specific versions of an API. For example, "intercept all FetchRequest
messages greater than api version 7". To do this you can override a method named <code>shouldHandleXyz[Request|Response]</code> on your filter like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kd">class</span> <span class="tok-nc">FetchFilter</span><span class="tok-w"> </span><span class="tok-kd">implements</span><span class="tok-w"> </span><span class="tok-n">FetchRequestFilter</span><span class="tok-w"> </span><span class="tok-p">{</span>

<span class="tok-w">    </span><span class="tok-nd">@Override</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-kt">boolean</span><span class="tok-w"> </span><span class="tok-nf">shouldHandleFetchRequest</span><span class="tok-p">(</span><span class="tok-kt">short</span><span class="tok-w"> </span><span class="tok-n">apiVersion</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">apiVersion</span><span class="tok-w"> </span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-mi">7</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-nd">@Override</span>
<span class="tok-w">    </span><span class="tok-nd">@Override</span>
<span class="tok-w">    </span><span class="tok-kd">public</span><span class="tok-w"> </span><span class="tok-n">CompletionStage</span><span class="tok-o">&lt;</span><span class="tok-n">RequestFilterResult</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-nf">onRequest</span><span class="tok-p">(</span><span class="tok-n">ApiKeys</span><span class="tok-w"> </span><span class="tok-n">apiKey</span><span class="tok-p">,</span>
<span class="tok-w">                                                          </span><span class="tok-n">RequestHeaderData</span><span class="tok-w"> </span><span class="tok-n">header</span><span class="tok-p">,</span>
<span class="tok-w">                                                          </span><span class="tok-n">ApiMessage</span><span class="tok-w"> </span><span class="tok-n">body</span><span class="tok-p">,</span>
<span class="tok-w">                                                          </span><span class="tok-n">FilterContext</span><span class="tok-w"> </span><span class="tok-n">filterContext</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">context</span><span class="tok-p">.</span><span class="tok-na">forwardRequest</span><span class="tok-p">(</span><span class="tok-n">header</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">request</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_filter_construction_and_configuration"><a class="anchor" href="#_filter_construction_and_configuration"></a><a class="link" href="#_filter_construction_and_configuration">Filter Construction and Configuration</a></h4>
<div class="paragraph">
<p>For Kroxylicious to instantiate and configure your custom filter we use Java&#8217;s <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/ServiceLoader.html">ServiceLoader</a> API.
Each Custom Filter should provide a corresponding <a href="https://javadoc.io/doc/io.kroxylicious/kroxylicious-api/latest/io/kroxylicious/proxy/filter/FilterFactory.html">FilterFactory</a>
implementation that can create an instance of your custom Filter. The factory can optionally declare a configuration class that Kroxylicious will
populate (using Jackson) when loading your custom Filter. The module must package a <code>META-INF/services/io.kroxylicious.proxy.filter.FilterFactory</code>
file containing the classnames of each filter factory implementation into the JAR file.</p>
</div>
<div class="paragraph">
<p>For example in the kroxylicious-samples we have the <a href="https://github.com/kroxylicious/kroxylicious/blob/main/kroxylicious-sample/src/main/java/io/kroxylicious/sample/config/SampleFilterConfig.java">SampleFilterConfig</a> class.
This is used in the <a href="https://github.com/kroxylicious/kroxylicious/blob/main/kroxylicious-sample/src/main/java/io/kroxylicious/sample/SampleFetchResponseFilter.java">SampleFetchResponseFilter</a>). The configuration is routed to the Filter instance via the
<a href="https://github.com/kroxylicious/kroxylicious/blob/main/kroxylicious-sample/src/main/java/io/kroxylicious/sample/SampleFetchResponseFilterFactory.java">SampleFetchResponseFilterFactory</a>.</p>
</div>
<div class="paragraph">
<p>Then, when we configure a filter in Kroxylicious configuration like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">filters</span><span class="tok-p">:</span>
<span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">SampleFetchResponseFilterFactory</span>
<span class="tok-w">  </span><span class="tok-nt">config</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">findValue</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">a</span>
<span class="tok-w">    </span><span class="tok-nt">replacementValue</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">b</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Kroxylicious will deserialize the <code>config</code> object into a <code>SampleFilterConfig</code> and use it to construct a
<code>SampleFetchResponseFilter</code> passing the <code>SampleFilterConfig</code> instance as a constructor argument.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_packaging_filters"><a class="anchor" href="#_packaging_filters"></a><a class="link" href="#_packaging_filters">Packaging filters</a></h3>
<div class="paragraph">
<p>Filters are packaged as standard <code>.jar</code> files. A typical Custom Filter jar contains:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Filter implementation classes</p>
</li>
<li>
<p>A FilterFactory implementation per Filter and service metadata (see <a href="#_filter_construction_and_configuration">Filter Construction and Configuration</a>)</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploying_proxies"><a class="anchor" href="#_deploying_proxies"></a><a class="link" href="#_deploying_proxies">Deploying proxies</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Topologies etc</p>
</div>
<div class="sect2">
<h3 id="_selecting_plugins"><a class="anchor" href="#_selecting_plugins"></a><a class="link" href="#_selecting_plugins">Selecting plugins</a></h3>
<div class="paragraph">
<p>Put the filter jars in some directory</p>
</div>
</div>
<div class="sect2">
<h3 id="_providing_implementations_for_facades"><a class="anchor" href="#_providing_implementations_for_facades"></a><a class="link" href="#_providing_implementations_for_facades">Providing implementations for facades</a></h3>

</div>
<div class="sect2">
<h3 id="_configuring_virtual_clusters"><a class="anchor" href="#_configuring_virtual_clusters"></a><a class="link" href="#_configuring_virtual_clusters">Configuring virtual clusters</a></h3>
<div class="paragraph">
<p>As described earlier, the <em>Virtual Cluster</em> is the downstream representation of a Kafka Cluster.  Kafka Client connect
to the Virtual Cluster.</p>
</div>
<div class="paragraph">
<p>You must define at least one Virtual Cluster.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at how that is done by considering first a simple example.  After we will look at more advanced options
including TLS.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">virtualClusters</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">demo</span><span class="tok-p">:</span><span class="tok-w">                                         </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">    </span><span class="tok-nt">targetCluster</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">bootstrap_servers</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">myprivatecluster:9092</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-nt">clusterNetworkAddressConfigProvider</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">PortPerBrokerClusterNetworkAddressConfigProvider</span><span class="tok-w">                       </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">      </span><span class="tok-nt">config</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">bootstrapAddress</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mypublickroxylicious:9192</span><span class="tok-w">    </span><i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The name of the virtual cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The bootstrap of the (physical) Kafka Cluster.  This is the Kafka Cluster being proxied.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The name of a cluster network address config provider. The built-in types are <code>PortPerBrokerClusterNetworkAddressConfigProvider</code> and <code>SniRoutingClusterNetworkAddressConfigProvider</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The hostname and port of the bootstrap that will be used by the Kafka Clients.  The hostname must be resolved
by the clients.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This configuration declares a virtual cluster called <code>demo</code>.  The physical Kafka Cluster being proxied is the defined
by the <code>targetCluster</code> element.  In this example, the <code>PortPerBroker</code> scheme is used by Kroxlicious to present the
virtual cluster to the clients.  Under this schema, Kroxylicious will open a port for each broker of the target cluster
with port numbers beginning at <code>9192</code> +1.  So, if the target cluster has three brokers, Kroxylicious will bind 9192 for
bootstrap and 9193-9195 inclusive to allow the clients to connect to each broker.</p>
</div>
<div class="sect3">
<h4 id="_cluster_network_address_config_providers"><a class="anchor" href="#_cluster_network_address_config_providers"></a><a class="link" href="#_cluster_network_address_config_providers">Cluster Network Address Config Providers</a></h4>
<div class="paragraph">
<p>The Cluster Network Address Config Provider controls how the virtual cluster is presented to the network. Two
alternatives are supported: <code>PortPerBroker</code> and <code>SniRouting</code> which have different characteristics which make each
suitable for different use-cases. They are described next.</p>
</div>
<div class="sect4">
<h5 id="_portperbroker_scheme"><a class="anchor" href="#_portperbroker_scheme"></a><a class="link" href="#_portperbroker_scheme">PortPerBroker scheme</a></h5>
<div class="paragraph">
<p>In the <code>PortPerBroker</code> scheme, Kroxylicious automatically opens a port for each virtual cluster&#8217;s bootstrap and
one port per broker of each target cluster.  So, if you have two virtual clusters, each targeting a Kafka Cluster
of three brokers, Kroxylicious will bind eight ports in total.</p>
</div>
<div class="paragraph">
<p>Kroxylicious monitors the broker topology of the target cluster at runtime. It will adjust the number of open ports
dynamically.  If another broker is added to the Kafka Cluster, Kroxylicious will automatically open a port for it.
Similarly, if a broker is removed from the Kafka Cluster, Kroxylicious will automatically close the port that was
assigned to it.</p>
</div>
<div class="paragraph">
<p>The <code>PortPerBroker</code> scheme can be used with either clear text or TLS downstream connections.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">clusterNetworkAddressConfigProvider</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">PortPerBrokerClusterNetworkAddressConfigProvider</span>
<span class="tok-w">  </span><span class="tok-nt">config</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">bootstrapAddress</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mycluster.kafka.com:9192</span><span class="tok-w">                   </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">    </span><span class="tok-nt">brokerAddressPattern</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mybroker-$(nodeId).mycluster.kafka.com</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-nt">brokerStartPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">9193</span><span class="tok-w">                                        </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">    </span><span class="tok-nt">numberOfBrokerPorts</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3</span><span class="tok-w">                                       </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">    </span><span class="tok-nt">bindAddress</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">192.168.0.1</span><span class="tok-w">                                     </span><i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The hostname and port of the bootstrap that will be used by the Kafka Clients.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>(Optional) The broker address pattern used to form the broker addresses.  If not defined, it defaults to the
hostname part of the <code>bootstrapAddress</code> and the port number allocated to the broker.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>(Optional) The starting number for broker port range. Defaults to the port of the <code>bootstrapAddress</code> plus 1.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>(Optional) The <em>maximum</em> number of brokers of ports that are permitted.  Defaults to 3.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>(Optional) The bind address used when binding the ports. If undefined, all network interfaces will be bound.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>brokerAddressPattern</code> configuration parameter understands the replacement token <code>$(nodeId)</code>. It is optional.
If present, it will be replaced by the <a href="https://kafka.apache.org/documentation/#brokerconfigs_node.id"><code>node.id</code></a> (or
<code>broker.id</code>) assigned to the broker of the target cluster.</p>
</div>
<div class="paragraph">
<p>For example if your configuration looks like the above and your cluster has three brokers, your Kafka Client will receive
broker address information like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>0.  `mybroker-0.mycluster.kafka.com:9193`
1.  `mybroker-1.mycluster.kafka.com:9194`
2.  `mybroker-2.mycluster.kafka.com:9194`</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is a responsibility for the deployer of Kroxylicious to ensure that the bootstrap and generated broker
DNS names are resolvable and routable by the Kafka Client.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>numberOfBrokerPorts</code> imposes a maximum on the number of brokers that a Kafka Cluster can have. Set this value
to be as high as the maximum number of brokers that your operational rules allow for a Kafka Cluster.</p>
</div>
</div>
<div class="sect4">
<h5 id="_snirouting_scheme"><a class="anchor" href="#_snirouting_scheme"></a><a class="link" href="#_snirouting_scheme">SniRouting scheme</a></h5>
<div class="paragraph">
<p>In the <code>SniRouting</code> scheme, Kroxylicious uses SNI information to route traffic to either the boostrap or individual
brokers.   As this relies on SNI (Server Name Indication), the use of <a href="#_downstream_tls">Downstream TLS</a> is <strong>required</strong>.</p>
</div>
<div class="paragraph">
<p>With this scheme, you have the choice to share a single port across all virtual clusters, or you can assign a different
port to each.  Single port operation may have cost advantages when using load balancers of public clouds, as it allows
a single cloud provider load balancer to be shared across all virtual clusters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">clusterNetworkAddressConfigProvider</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">SniRoutingClusterNetworkAddressConfigProvider</span>
<span class="tok-w">  </span><span class="tok-nt">config</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">bootstrapAddress</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mycluster.kafka.com:9192</span><span class="tok-w">                    </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">    </span><span class="tok-nt">brokerAddressPattern</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mybroker-$(nodeId).mycluster.kafka.com</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-nt">bindAddress</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">192.168.0.1</span><span class="tok-w">                                      </span><i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The hostname and port of the bootstrap that will be used by the Kafka Clients.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The broker address pattern used to form the broker addresses. The <code>$(nodeId)</code> token must be present.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>(Optional) The bind address used when binding the port. If undefined, all network interfaces will be bound.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>brokerAddressPattern</code> configuration parameters requires that the <code>$(nodeId)</code> token is present within it.
This is replaced by the <a href="https://kafka.apache.org/documentation/#brokerconfigs_node.id"><code>node.id</code></a> (or `broker.id)
assigned to the broker of the target cluster.  This allows Kroxylicious to generate separate routes for each broker.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is a responsibility for the deployer of Kroxylicious to ensure that the bootstrap and generated broker
DNS names are resolvable and routable by the Kafka Client.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_transport_layer_security_tls"><a class="anchor" href="#_transport_layer_security_tls"></a><a class="link" href="#_transport_layer_security_tls">Transport Layer Security (TLS)</a></h4>
<div class="paragraph">
<p>In this section we look at how to enable TLS for either the downstream and/or upstream.   Note, there is no
interdependency; it is supported to have TLS configured for the downstream and use clear text communications for the
upstream, or vice-versa.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
TLS is recommended for both upstream and downstream for production configurations.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_downstream_tls"><a class="anchor" href="#_downstream_tls"></a><a class="link" href="#_downstream_tls">Downstream TLS</a></h4>
<div class="paragraph">
<p>Here&#8217;s how to enable TLS for the downstream side. This means the Kafka Client will connect to the virtual cluster over
TLS rather than clear text.  For this, you will need to obtain a TLS certificate for the virtual cluster from your
Certificate Authority.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When requesting the certificate ensure that the certificate will match the names of the virtual cluster&#8217;s
bootstrap and broker addresses.  This may mean making use of wildcard certificates and/or Subject Alternative Names (SANs).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Kroxylicious accepts key material in PKCS12 or JKS keystore format, or PEM formatted file(s).  The following configuration
illustrates configuration with PKCS12 keystore.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">virtualClusters</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">demo</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">tls</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">key</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">storeFile</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/opt/cert/server.p12</span><span class="tok-w">               </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">          </span><span class="tok-nt">storePassword</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">passwordFile</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/opt/cert/store.password</span><span class="tok-w">      </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">          </span><span class="tok-nt">keyPassword</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">passwordFile</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/opt/cert/key.password</span><span class="tok-w">        </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">          </span><span class="tok-nt">storeType</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">PKCS12</span><span class="tok-w">                             </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">    </span><span class="tok-nt">clusterNetworkAddressConfigProvider</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">...</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>File system location of a keystore (or in the case of <code>PEM</code> format a text file containing the concatenation of the
private key, certificate, and intermediates).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>File system location of a file containing the key store&#8217;s password.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>(Optional) File system location of a file containing the key&#8217;s password. If omitted the key store&#8217;s password is
used to decrypt the key too.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>(Optional) Store type. Supported types are: <code>PKCS12</code>, <code>JKS</code> and <code>PEM</code>.  Defaults to Java default key store type
which is usually <code>PKCS12</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively, if your key material is in separate PEM files (private key, and certificate/intermediates), the following
configuration may be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">virtualClusters</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">demo</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">tls</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">key</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">privateKeyFile</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/opt/cert/server.key</span><span class="tok-w">          </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">          </span><span class="tok-nt">certificateFile</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/opt/cert/server.crt</span><span class="tok-w">         </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">          </span><span class="tok-nt">keyPassword</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">passwordFile</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/opt/cert/key.password</span><span class="tok-w">        </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">    </span><span class="tok-nt">clusterNetworkAddressConfigProvider</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">...</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>File system location of the server private key.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>File system location of the server certificate and intermediate(s).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>(Optional) File system location of a file containing the key&#8217;s password.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For the private-key, <a href="https://datatracker.ietf.org/doc/html/rfc5208">PKCS-8 keys</a> are supported by default.
For <a href="https://datatracker.ietf.org/doc/html/rfc8017">PKCS-1 keys</a>, <a href="https://www.bouncycastle.org/">Bouncycastle</a> libraries
must be added to the Kroxylicious classpath. See <a href="https://github.com/netty/netty/issues/7323" class="bare">https://github.com/netty/netty/issues/7323</a> for more details.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_upstream_tls"><a class="anchor" href="#_upstream_tls"></a><a class="link" href="#_upstream_tls">Upstream TLS</a></h4>
<div class="paragraph">
<p>Here&#8217;s how to enable TLS for the upstream side.  This means that Kroxylicious connects to the (physical) Kafka Cluster)
over TLS.  For this, your Kafka Cluster must have already been configured to use TLS.</p>
</div>
<div class="paragraph">
<p>By default, Kroxylicious inherits what it trusts from the platform it is running on and uses this to determine whether
the Kafka Cluster is trusted or not.</p>
</div>
<div class="paragraph">
<p>To support cases where trust must be overridden (such as use-cases involving the use of private CAs or self-signed
certificates), Kroxylicious accepts override trust material in PKCS12 or JKS keystore format, or PEM formatted
certificates.</p>
</div>
<div class="paragraph">
<p>The following illustrates enabling TLS, inheriting platform trust:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">virtualClusters</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">demo</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">targetCluster</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">bootstrap_servers</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">myprivatecluster:9092</span>
<span class="tok-w">      </span><span class="tok-nt">tls</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">{}</span><span class="tok-w">                                         </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">      </span><span class="tok-c1">#...</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use an empty object to enable TLS inheriting trust from the platform.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following illustrates enabling TLS but with trust coming from a PKCS12 trust store instead of the platform:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">virtualClusters</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">demo</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">targetCluster</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">bootstrap_servers</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">myprivatecluster:9092</span>
<span class="tok-w">      </span><span class="tok-nt">tls</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">trust</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">storeFile</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/opt/cert/trust.p12</span><span class="tok-w">                </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">          </span><span class="tok-nt">storePassword</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">passwordFile</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/opt/cert/store.password</span><span class="tok-w">      </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">          </span><span class="tok-nt">storeType</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">PKCS12</span><span class="tok-w">                             </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">      </span><span class="tok-c1">#...</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>File system location of a truststore (or in the case of <code>PEM</code> format a text file containing the certificates).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>File system location of a file containing the trust store&#8217;s password.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>(Optional) Trust store type. Supported types are: <code>PKCS12</code>, <code>JKS</code> and <code>PEM</code>.  Defaults to Java default key store type (PKCS12).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following illustrates connection to physical cluster using TLS client authentication (aka Mutual TLS).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">virtualClusters</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">demo</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">targetCluster</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">bootstrap_servers</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">myprivatecluster:9092</span>
<span class="tok-w">      </span><span class="tok-nt">tls</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">key</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">privateKeyFile</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/opt/cert/client.key</span>
<span class="tok-w">          </span><span class="tok-nt">certificateFile</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/opt/cert/client.cert</span>
<span class="tok-w">        </span><span class="tok-nt">trust</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">storeFile</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/opt/cert/client/server.cer</span>
<span class="tok-w">          </span><span class="tok-nt">storeType</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">PEM</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to disable trust so that Kroxylicious will connect to any Kafka Cluster regardless of its certificate
validity.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This option is not recommended for production use.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">virtualClusters</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">demo</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">targetCluster</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">bootstrap_servers</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">myprivatecluster:9092</span>
<span class="tok-w">      </span><span class="tok-nt">tls</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">trust</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">insecure</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">                                </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">      </span><span class="tok-c1">#...</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enables insecure TLS.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>YAML
Proxy level configuration</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_proxy_plugins"><a class="anchor" href="#_configuring_proxy_plugins"></a><a class="link" href="#_configuring_proxy_plugins">Configuring proxy plugins</a></h3>
<div class="paragraph">
<p>Filter level configuration</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_operating_proxies"><a class="anchor" href="#_operating_proxies"></a><a class="link" href="#_operating_proxies">Operating proxies</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_logging"><a class="anchor" href="#_logging"></a><a class="link" href="#_logging">Logging</a></h3>
<div class="paragraph">
<p>The Kroxylicious <a href="https://github.com/kroxylicious/kroxylicious/releases/latest">binary distributions</a> ship with <a href="https://logging.apache.org/log4j/2.x">log4j2</a> as a logging backend. To customize the logging configuration:</p>
</div>
<div class="sect3">
<h4 id="_1_use_an_alternative_log4j_configuration_file"><a class="anchor" href="#_1_use_an_alternative_log4j_configuration_file"></a><a class="link" href="#_1_use_an_alternative_log4j_configuration_file">1. Use an Alternative Log4j configuration file</a></h4>
<div class="paragraph">
<p>When using <a href="https://github.com/kroxylicious/kroxylicious/blob/main/kroxylicious-app/src/assembly/kroxylicious-start.sh">bin/kroxylicious-start.sh</a> from the binary distribution, you can optionally set an environment variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span><span class="tok-nv">KROXYLICIOUS_LOGGING_OPTIONS</span><span class="tok-o">=</span><span class="tok-s2">&quot;-Dlog4j2.configurationFile=/path/to/custom/log4j2.yaml&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>to load an alternative log4j2 configuration.</p>
</div>
</div>
<div class="sect3">
<h4 id="_2_change_the_root_log_level"><a class="anchor" href="#_2_change_the_root_log_level"></a><a class="link" href="#_2_change_the_root_log_level">2. Change the Root Log level</a></h4>
<div class="paragraph">
<p>When using <a href="https://github.com/kroxylicious/kroxylicious/blob/main/kroxylicious-app/src/assembly/kroxylicious-start.sh">bin/kroxylicious-start.sh</a> from the binary distribution and using the default logging configuration file, you can set an environment variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span><span class="tok-nv">KROXYLICIOUS_ROOT_LOG_LEVEL</span><span class="tok-o">=</span><span class="tok-s2">&quot;DEBUG&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>to configure the root log level (note this will be very verbose at DEBUG/TRACE)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_tls"><a class="anchor" href="#_configuring_tls"></a><a class="link" href="#_configuring_tls">Configuring TLS</a></h3>

</div>
<div class="sect2">
<h3 id="_reconfiguration"><a class="anchor" href="#_reconfiguration"></a><a class="link" href="#_reconfiguration">Reconfiguration</a></h3>

</div>
<div class="sect2">
<h3 id="_monitoring_and_observability"><a class="anchor" href="#_monitoring_and_observability"></a><a class="link" href="#_monitoring_and_observability">Monitoring and observability</a></h3>
<div class="paragraph">
<p>Kroxylicious uses micrometer as a facade for gathering metrics. A Prometheus backend is the only supported implementation so far.</p>
</div>
<div class="sect3">
<h4 id="_admin_http_endpoint"><a class="anchor" href="#_admin_http_endpoint"></a><a class="link" href="#_admin_http_endpoint">Admin HTTP Endpoint</a></h4>
<div class="paragraph">
<p>Kroxylicious offers a configurable, insecure, HTTP endpoint for adminstration purposes. It can
offer:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Prometheus scrape endpoint at <code>/metrics</code></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_minimal_configuration_example"><a class="anchor" href="#_minimal_configuration_example"></a><a class="link" href="#_minimal_configuration_example">minimal configuration example</a></h5>
<div class="listingblock">
<div class="content">
<pre>adminHttp:
  endpoints:
    prometheus: {}</pre>
</div>
</div>
<div class="paragraph">
<p>Defaults to binding to <code>0.0.0.0:9190</code>. If no endpoints are configured the admin http server
is not created.</p>
</div>
</div>
<div class="sect4">
<h5 id="_complete_configuration_example"><a class="anchor" href="#_complete_configuration_example"></a><a class="link" href="#_complete_configuration_example">complete configuration example</a></h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">adminHttp</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">host</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">localhost</span><span class="tok-w"> </span><span class="tok-c1">#1</span>
<span class="tok-w">  </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">9999</span><span class="tok-w"> </span><span class="tok-c1">#1</span>
<span class="tok-w">  </span><span class="tok-nt">endpoints</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">prometheus</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">{}</span><span class="tok-w"> </span><span class="tok-c1">#2</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>offers an insecure admin HTTP endpoint listening on localhost:9999</p>
</li>
<li>
<p>offers a prometheus scrape endpoint at <code>/metrics</code> on the admin endpoint</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_micrometer_metrics"><a class="anchor" href="#_micrometer_metrics"></a><a class="link" href="#_micrometer_metrics">Micrometer Metrics</a></h4>
<div class="paragraph">
<p>Kroxylicious integrates with <a href="https://micrometer.io/docs">micrometer</a>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Micrometer provides a simple facade over the instrumentation clients for the most popular observability systems, allowing you to instrument your JVM-based application code without vendor lock-in.</p>
</div>
</blockquote>
</div>
<div class="sect4">
<h5 id="_complete_configuration_example_2"><a class="anchor" href="#_complete_configuration_example_2"></a><a class="link" href="#_complete_configuration_example_2">complete configuration example</a></h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">adminHttp</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">endpoints</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">prometheus</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">{}</span>
<span class="tok-nt">micrometer</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;CommonTagsHook&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">config</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">commonTags</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">zone</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;euc-1a&quot;</span><span class="tok-w"> </span><span class="tok-c1">#1</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;StandardBindersHook&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">config</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">binderNames</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-s">&quot;JvmGcMetrics&quot;</span><span class="tok-w"> </span><span class="tok-c1">#2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This configuration:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>configures a common tag on the global micrometer registry of <code>zone: euc-1a</code> to add to all metrics (becomes a label in prometheus)</p>
</li>
<li>
<p>registers a JvmGcMetrics binder with the global registry (shipped with micrometer)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Prometheus is connected to the micrometer global registry so Filters can record metrics against
it, and they will be available as part of the Prometheus scrape data.</p>
</div>
<div class="paragraph">
<p>If you executed <code>curl localhost:9999/metrics</code> you should see metrics like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>jvm_gc_memory_allocated_bytes_total{zone="euc-1a",} 0.0</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_common_tags"><a class="anchor" href="#_common_tags"></a><a class="link" href="#_common_tags">Common Tags</a></h5>
<div class="paragraph">
<p>We can add common tags that will be added to all metrics. These will be available as labels
from the Prometheus scrape.</p>
</div>
<div class="paragraph">
<p>To configure common tags use configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;CommonTagsHook&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">config</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">commonTags</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">zone</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;euc-1a&quot;</span>
<span class="tok-w">        </span><span class="tok-nt">owner</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;becky&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_standard_binders"><a class="anchor" href="#_standard_binders"></a><a class="link" href="#_standard_binders">Standard Binders</a></h5>
<div class="paragraph">
<p>Micrometer has a concept of MeterBinder:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Binders register one or more metrics to provide information about the state of some aspect of the application or its container.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>By registering some standard binders shipped with micrometer you can expose metrics
about the JVM and system which can observe JVM memory usage, garbage collection
and other behaviour.</p>
</div>
<div class="paragraph">
<p>To configure multiple binders you can use configuration like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">micrometer</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;StandardBindersHook&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">config</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">binderNames</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-s">&quot;JvmGcMetrics&quot;</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-s">&quot;JvmHeapPressureMetrics&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And those named binders will be bound to the global meter registry</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Available Binders</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">micrometer class</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ClassLoaderMetrics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.micrometer.core.instrument.binder.jvm.ClassLoaderMetrics</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JvmCompilationMetrics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.micrometer.core.instrument.binder.jvm.JvmCompilationMetrics</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JvmGcMetrics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.micrometer.core.instrument.binder.jvm.JvmGcMetrics</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JvmHeapPressureMetrics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.micrometer.core.instrument.binder.jvm.JvmHeapPressureMetrics</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JvmInfoMetrics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.micrometer.core.instrument.binder.jvm.JvmInfoMetrics</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JvmMemoryMetrics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.micrometer.core.instrument.binder.jvm.JvmMemoryMetrics</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JvmThreadMetrics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.micrometer.core.instrument.binder.jvm.JvmThreadMetrics</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FileDescriptorMetrics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.micrometer.core.instrument.binder.system.FileDescriptorMetrics</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ProcessorMetrics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.micrometer.core.instrument.binder.system.ProcessorMetrics</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">UptimeMetrics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.micrometer.core.instrument.binder.system.UptimeMetrics</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_micrometer_usage_from_filters"><a class="anchor" href="#_micrometer_usage_from_filters"></a><a class="link" href="#_micrometer_usage_from_filters">Micrometer Usage from Filters</a></h5>
<div class="paragraph">
<p>Filters can use the static methods of <a href="https://www.javadoc.io/doc/io.micrometer/micrometer-core/1.10.5/io/micrometer/core/instrument/Metrics.html">Metrics</a>
to register metrics with the global registry. Or use <code>Metrics.globalRegistry</code> to
get a reference to the global registry. Metrics registered this way will be
automatically available through the prometheus scrape endpoint.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. The example token create command illustrates the use of <code>-no-default-policy</code> and <code>-orphan</code>. The use of these flags is not functionally important.  You may adapt the configuration of the token to suit the standards required by your organization
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. The <code>context.forward*()</code> methods behave exactly as the builder form <code>.forward(header, message).complete()</code>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-02-26 09:17:18 UTC
</div>
</div>
</body>
</html>